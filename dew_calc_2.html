<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Калькулятор точки росы кислотной коррозии | Acid Dew Point Calculator</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <style>
        :root {
            --primary-color: #0c4da2;
            --secondary-color: #3a7bd5;
            --accent-color: #00bcd4;
            --danger-zone: rgba(255, 0, 0, 0.1);
            --warning-zone: rgba(255, 165, 0, 0.1);
            --safe-zone: rgba(0, 128, 0, 0.1);
        }
        
        body {
            font-family: 'Roboto', 'Arial', sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f8f9fa;
        }
        
        .header-gradient {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        }
        
        .tab-active {
            border-bottom: 3px solid var(--accent-color);
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            transition: all 0.3s;
        }
        
        .card:hover {
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }
        
        .form-control {
            display: block;
            width: 100%;
            padding: 0.5rem;
            font-size: 1rem;
            line-height: 1.5;
            color: #495057;
            background-color: #fff;
            background-clip: padding-box;
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        
        .form-control:focus {
            border-color: var(--secondary-color);
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(58, 123, 213, 0.25);
        }
        
        .range-slider {
            width: 100%;
            height: 5px;
            border-radius: 5px;
            background: #d7dcdf;
            outline: none;
            -webkit-appearance: none;
        }
        
        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--secondary-color);
            cursor: pointer;
            border: none;
        }
        
        .range-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--secondary-color);
            cursor: pointer;
            border: none;
        }
        
        .parameter-card {
            transition: all 0.3s ease;
        }
        
        .parameter-card:hover {
            transform: translateY(-5px);
        }
        
        .result-card {
            border-left: 4px solid var(--primary-color);
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 250px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8rem;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        .method-description {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out;
        }
        
        .method-description.active {
            max-height: 1000px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Animation */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        .corrosion-risk-low {
            background-color: var(--safe-zone);
            color: darkgreen;
        }
        
        .corrosion-risk-medium {
            background-color: var(--warning-zone);
            color: darkorange;
        }
        
        .corrosion-risk-high {
            background-color: var(--danger-zone);
            color: darkred;
        }
        
        .lang-ru, .lang-en {
            display: none;
        }
        
        .table-striped tbody tr:nth-of-type(odd) {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .equation {
            font-family: 'Times New Roman', Times, serif;
            padding: 10px;
            border-radius: 5px;
            background-color: #f9f9f9;
            display: inline-block;
            margin: 10px 0;
        }
        
        .print-friendly {
            color-adjust: exact;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        
        @media print {
            .no-print {
                display: none;
            }
            
            .page-break {
                page-break-before: always;
            }
            
            body {
                font-size: 12pt;
            }
            
            .card {
                break-inside: avoid;
            }
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                padding-left: 1rem;
                padding-right: 1rem;
            }
            
            .grid-cols-2, .grid-cols-3 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="print-friendly">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="header-gradient text-white py-6 px-4 rounded-lg shadow-lg mb-8">
            <div class="flex flex-wrap items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold lang-ru">Калькулятор точки росы кислотной коррозии</h1>
                    <h1 class="text-3xl font-bold lang-en">Acid Dew Point Calculator</h1>
                    <p class="text-sm mt-2 max-w-lg lang-ru">Научно точный инструмент для расчета температуры точки росы H₂SO₄, HCl и H₂S в газовых потоках</p>
                    <p class="text-sm mt-2 max-w-lg lang-en">Scientifically accurate tool for calculating acid dew point temperatures of H₂SO₄, HCl, and H₂S in gas streams</p>
                </div>
                <div class="flex items-center mt-4 sm:mt-0">
                    <button id="langToggle" class="btn-primary flex items-center" onclick="toggleLanguage()">
                        <i class="fas fa-globe mr-2"></i>
                        <span class="lang-ru">EN</span>
                        <span class="lang-en">RU</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main>
            <!-- Tab Navigation -->
            <div class="flex flex-wrap border-b border-gray-200 mb-6 no-print">
                <button class="tab-btn px-4 py-2 mr-2 tab-active" data-tab="calculator">
                    <i class="fas fa-calculator mr-2"></i>
                    <span class="lang-ru">Калькулятор</span>
                    <span class="lang-en">Calculator</span>
                </button>
                <button class="tab-btn px-4 py-2 mr-2" data-tab="reference-data">
                    <i class="fas fa-table mr-2"></i>
                    <span class="lang-ru">Справочные данные</span>
                    <span class="lang-en">Reference Data</span>
                </button>
                <button class="tab-btn px-4 py-2 mr-2" data-tab="theory">
                    <i class="fas fa-book mr-2"></i>
                    <span class="lang-ru">Теория и формулы</span>
                    <span class="lang-en">Theory & Formulas</span>
                </button>
                <button class="tab-btn px-4 py-2 mr-2" data-tab="recommendations">
                    <i class="fas fa-shield-alt mr-2"></i>
                    <span class="lang-ru">Рекомендации</span>
                    <span class="lang-en">Recommendations</span>
                </button>
                <button class="tab-btn px-4 py-2" data-tab="references">
                    <i class="fas fa-book-open mr-2"></i>
                    <span class="lang-ru">Источники</span>
                    <span class="lang-en">References</span>
                </button>
            </div>

            <!-- Calculator Tab Content -->
            <div id="calculator" class="tab-content active fade-in">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Input Parameters Section -->
                    <div class="lg:col-span-1">
                        <div class="card p-6 mb-6">
                            <h2 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">
                                <i class="fas fa-sliders-h mr-2 text-blue-600"></i>
                                <span class="lang-ru">Параметры расчета</span>
                                <span class="lang-en">Calculation Parameters</span>
                            </h2>
                            
                            <!-- Acid Type Selection -->
                            <div class="mb-4">
                                <label class="block text-gray-700 font-medium mb-2">
                                    <span class="lang-ru">Тип кислоты</span>
                                    <span class="lang-en">Acid Type</span>
                                </label>
                                <div class="grid grid-cols-3 gap-2">
                                    <button id="acid-h2so4" class="acid-type-btn btn-primary py-2 px-3 rounded-md text-sm" data-acid="h2so4">H₂SO₄</button>
                                    <button id="acid-hcl" class="acid-type-btn bg-gray-200 text-gray-700 py-2 px-3 rounded-md text-sm" data-acid="hcl">HCl</button>
                                    <button id="acid-h2s" class="acid-type-btn bg-gray-200 text-gray-700 py-2 px-3 rounded-md text-sm" data-acid="h2s">H₂S</button>
                                </div>
                            </div>
                            
                            <!-- Calculation Method -->
                            <div class="mb-4" id="method-selection-h2so4">
                                <label class="block text-gray-700 font-medium mb-2">
                                    <span class="lang-ru">Метод расчета</span>
                                    <span class="lang-en">Calculation Method</span>
                                </label>
                                <select id="calculation-method-h2so4" class="form-control">
                                    <option value="okkes" class="lang-ru">Okkes (1987) - стандартный метод</option>
                                    <option value="okkes" class="lang-en">Okkes (1987) - standard method</option>
                                    <option value="verhoff" class="lang-ru">Verhoff & Banchero (1974)</option>
                                    <option value="verhoff" class="lang-en">Verhoff & Banchero (1974)</option>
                                    <option value="zarenezhad" class="lang-ru">ZareNezhad (2009)</option>
                                    <option value="zarenezhad" class="lang-en">ZareNezhad (2009)</option>
                                    <option value="all" class="lang-ru">Все методы (сравнение)</option>
                                    <option value="all" class="lang-en">All methods (comparison)</option>
                                </select>
                            </div>
                            
                            <div class="mb-4 hidden" id="method-selection-hcl">
                                <label class="block text-gray-700 font-medium mb-2">
                                    <span class="lang-ru">Метод расчета</span>
                                    <span class="lang-en">Calculation Method</span>
                                </label>
                                <select id="calculation-method-hcl" class="form-control">
                                    <option value="kiang" class="lang-ru">Kiang (1981)</option>
                                    <option value="kiang" class="lang-en">Kiang (1981)</option>
                                </select>
                            </div>
                            
                            <div class="mb-4 hidden" id="method-selection-h2s">
                                <label class="block text-gray-700 font-medium mb-2">
                                    <span class="lang-ru">Метод расчета</span>
                                    <span class="lang-en">Calculation Method</span>
                                </label>
                                <select id="calculation-method-h2s" class="form-control">
                                    <option value="antoine" class="lang-ru">Уравнение Антуана (NIST)</option>
                                    <option value="antoine" class="lang-en">Antoine Equation (NIST)</option>
                                </select>
                            </div>
                            
                            <!-- Water Content -->
                            <div class="mb-4">
                                <label class="block text-gray-700 font-medium mb-2">
                                    <span class="lang-ru">Содержание воды (H₂O)</span>
                                    <span class="lang-en">Water Content (H₂O)</span>
                                </label>
                                <div class="flex mb-2">
                                    <input type="number" id="water-content" class="form-control mr-2" value="10" min="0" max="100" step="0.1">
                                    <select id="water-units" class="form-control w-24">
                                        <option value="percent">% об.</option>
                                        <option value="ppm">ppm</option>
                                        <option value="mg/nm3">мг/нм³</option>
                                    </select>
                                </div>
                                <input type="range" id="water-content-slider" class="range-slider" min="0" max="30" value="10" step="0.1">
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>0%</span>
                                    <span>15%</span>
                                    <span>30%</span>
                                </div>
                            </div>
                            
                            <!-- Acid Content (SO3) -->
                            <div class="mb-4" id="so3-content-container">
                                <label class="block text-gray-700 font-medium mb-2">
                                    <span class="lang-ru">Содержание SO₃</span>
                                    <span class="lang-en">SO₃ Content</span>
                                    <span class="tooltip">
                                        <i class="fas fa-info-circle text-blue-500"></i>
                                        <span class="tooltiptext lang-ru">В дымовых газах обычно 2-4% SO₂ конвертируется в SO₃</span>
                                        <span class="tooltiptext lang-en">In flue gases, typically 2-4% of SO₂ is converted to SO₃</span>
                                    </span>
                                </label>
                                <div class="flex mb-2">
                                    <input type="number" id="so3-content" class="form-control mr-2" value="5" min="0" max="1000" step="1">
                                    <select id="so3-units" class="form-control w-24">
                                        <option value="ppm">ppm</option>
                                        <option value="percent">% об.</option>
                                        <option value="mg/nm3">мг/нм³</option>
                                    </select>
                                </div>
                                <input type="range" id="so3-content-slider" class="range-slider" min="0" max="100" value="5" step="1">
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>0 ppm</span>
                                    <span>50 ppm</span>
                                    <span>100 ppm</span>
                                </div>
                            </div>
                            
                            <!-- Acid Content (HCl) -->
                            <div class="mb-4 hidden" id="hcl-content-container">
                                <label class="block text-gray-700 font-medium mb-2">
                                    <span class="lang-ru">Содержание HCl</span>
                                    <span class="lang-en">HCl Content</span>
                                </label>
                                <div class="flex mb-2">
                                    <input type="number" id="hcl-content" class="form-control mr-2" value="100" min="0" max="10000" step="1">
                                    <select id="hcl-units" class="form-control w-24">
                                        <option value="ppm">ppm</option>
                                        <option value="percent">% об.</option>
                                        <option value="mg/nm3">мг/нм³</option>
                                    </select>
                                </div>
                                <input type="range" id="hcl-content-slider" class="range-slider" min="0" max="1000" value="100" step="10">
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>0 ppm</span>
                                    <span>500 ppm</span>
                                    <span>1000 ppm</span>
                                </div>
                            </div>
                            
                            <!-- Acid Content (H2S) -->
                            <div class="mb-4 hidden" id="h2s-content-container">
                                <label class="block text-gray-700 font-medium mb-2">
                                    <span class="lang-ru">Содержание H₂S</span>
                                    <span class="lang-en">H₂S Content</span>
                                </label>
                                <div class="flex mb-2">
                                    <input type="number" id="h2s-content" class="form-control mr-2" value="1" min="0" max="100" step="0.1">
                                    <select id="h2s-units" class="form-control w-24">
                                        <option value="percent">% об.</option>
                                        <option value="ppm">ppm</option>
                                        <option value="mg/nm3">мг/нм³</option>
                                    </select>
                                </div>
                                <input type="range" id="h2s-content-slider" class="range-slider" min="0" max="10" value="1" step="0.1">
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>0%</span>
                                    <span>5%</span>
                                    <span>10%</span>
                                </div>
                            </div>
                            
                            <!-- System Pressure -->
                            <div class="mb-4">
                                <label class="block text-gray-700 font-medium mb-2">
                                    <span class="lang-ru">Давление системы</span>
                                    <span class="lang-en">System Pressure</span>
                                </label>
                                <div class="flex mb-2">
                                    <input type="number" id="system-pressure" class="form-control mr-2" value="1" min="0.1" max="10" step="0.01">
                                    <select id="pressure-units" class="form-control w-24">
                                        <option value="atm">атм</option>
                                        <option value="bar">бар</option>
                                        <option value="kPa">кПа</option>
                                        <option value="mmHg">мм рт.ст.</option>
                                    </select>
                                </div>
                                <input type="range" id="system-pressure-slider" class="range-slider" min="0.5" max="2" value="1" step="0.01">
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>0.5 атм</span>
                                    <span>1 атм</span>
                                    <span>2 атм</span>
                                </div>
                            </div>
                            
                            <!-- Calculate Button -->
                            <button id="calculate-btn" class="btn-primary w-full py-3 font-bold text-lg">
                                <i class="fas fa-calculator mr-2"></i>
                                <span class="lang-ru">Рассчитать</span>
                                <span class="lang-en">Calculate</span>
                            </button>
                        </div>
                        
                        <!-- Intermediate Values Card -->
                        <div class="card p-6">
                            <h2 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">
                                <i class="fas fa-microscope mr-2 text-blue-600"></i>
                                <span class="lang-ru">Промежуточные значения</span>
                                <span class="lang-en">Intermediate Values</span>
                            </h2>
                            <div id="intermediate-values">
                                <div class="mb-3">
                                    <span class="font-medium lang-ru">Парциальное давление H₂O:</span>
                                    <span class="font-medium lang-en">H₂O Partial Pressure:</span>
                                    <span id="h2o-partial-pressure" class="ml-2">76.0 мм рт.ст.</span>
                                </div>
                                <div class="mb-3" id="so3-partial-section">
                                    <span class="font-medium lang-ru">Парциальное давление SO₃:</span>
                                    <span class="font-medium lang-en">SO₃ Partial Pressure:</span>
                                    <span id="so3-partial-pressure" class="ml-2">0.0038 мм рт.ст.</span>
                                </div>
                                <div class="mb-3 hidden" id="hcl-partial-section">
                                    <span class="font-medium lang-ru">Парциальное давление HCl:</span>
                                    <span class="font-medium lang-en">HCl Partial Pressure:</span>
                                    <span id="hcl-partial-pressure" class="ml-2">0.076 мм рт.ст.</span>
                                </div>
                                <div class="mb-3 hidden" id="h2s-partial-section">
                                    <span class="font-medium lang-ru">Парциальное давление H₂S:</span>
                                    <span class="font-medium lang-en">H₂S Partial Pressure:</span>
                                    <span id="h2s-partial-pressure" class="ml-2">7.6 мм рт.ст.</span>
                                </div>
                                <div class="text-xs text-gray-500 mt-4 border-t pt-2">
                                    <p class="lang-ru">Значения пересчитаны в единицы, используемые в формулах</p>
                                    <p class="lang-en">Values are converted to units used in formulas</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Results and Graphs Section -->
                    <div class="lg:col-span-2">
                        <!-- Results Card -->
                        <div class="card p-6 mb-6 result-card">
                            <h2 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">
                                <i class="fas fa-thermometer-half mr-2 text-blue-600"></i>
                                <span class="lang-ru">Результаты расчета</span>
                                <span class="lang-en">Calculation Results</span>
                            </h2>
                            <div id="results">
                                <!-- Calculation Results Will Be Displayed Here -->
                                <div id="single-method-results">
                                    <div class="flex flex-wrap gap-4">
                                        <div class="parameter-card bg-blue-50 p-4 rounded-lg shadow-sm border border-blue-100 flex-1 min-w-[240px] fade-in">
                                            <h3 class="font-bold text-blue-800 mb-2">
                                                <span id="acid-dew-point-title-ru" class="lang-ru">Точка росы H₂SO₄</span>
                                                <span id="acid-dew-point-title-en" class="lang-en">H₂SO₄ Dew Point</span>
                                            </h3>
                                            <div class="flex items-end">
                                                <span id="h2so4-dew-point" class="text-4xl font-bold text-blue-900">130.5</span>
                                                <span class="text-xl ml-1 text-blue-700">°C</span>
                                            </div>
                                            <div class="text-sm text-blue-600 mt-1" id="h2so4-dew-point-f">(266.9 °F)</div>
                                            <div class="text-xs text-gray-500 mt-2">
                                                <span class="lang-ru">Метод: Okkes (1987)</span>
                                                <span class="lang-en">Method: Okkes (1987)</span>
                                            </div>
                                        </div>
                                        
                                        <div class="parameter-card bg-green-50 p-4 rounded-lg shadow-sm border border-green-100 flex-1 min-w-[240px] fade-in">
                                            <h3 class="font-bold text-green-800 mb-2">
                                                <span class="lang-ru">Рекомендуемая температура</span>
                                                <span class="lang-en">Recommended Temperature</span>
                                            </h3>
                                            <div class="flex items-end">
                                                <span id="recommended-temp" class="text-4xl font-bold text-green-900">140.5</span>
                                                <span class="text-xl ml-1 text-green-700">°C</span>
                                            </div>
                                            <div class="text-sm text-green-600 mt-1" id="recommended-temp-f">(284.9 °F)</div>
                                            <div class="text-xs text-gray-500 mt-2">
                                                <span class="lang-ru">С запасом +10°C от точки росы</span>
                                                <span class="lang-en">With +10°C safety margin</span>
                                            </div>
                                        </div>
                                        
                                        <div class="parameter-card bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-100 flex-1 min-w-[240px] fade-in">
                                            <h3 class="font-bold text-gray-800 mb-2">
                                                <span class="lang-ru">Точка росы воды</span>
                                                <span class="lang-en">Water Dew Point</span>
                                            </h3>
                                            <div class="flex items-end">
                                                <span id="water-dew-point" class="text-4xl font-bold text-gray-900">45.8</span>
                                                <span class="text-xl ml-1 text-gray-700">°C</span>
                                            </div>
                                            <div class="text-sm text-gray-600 mt-1" id="water-dew-point-f">(114.4 °F)</div>
                                            <div class="text-xs text-gray-500 mt-2">
                                                <span class="lang-ru">При 10% об. H₂O и 1 атм</span>
                                                <span class="lang-en">At 10% vol. H₂O and 1 atm</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Reference Data Comparison -->
                                <div id="reference-data-comparison" class="mt-6 p-4 rounded-lg bg-blue-50 fade-in">
                                    <h3 class="font-bold text-lg mb-2">
                                        <i class="fas fa-table mr-2 text-blue-600"></i>
                                        <span class="lang-ru">Сравнение с табличными данными</span>
                                        <span class="lang-en">Reference Data Comparison</span>
                                    </h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
                                        <div class="bg-white p-3 rounded-md shadow-sm">
                                            <div class="font-medium text-blue-800 mb-1">
                                                <span class="lang-ru">Ближайшее табличное значение:</span>
                                                <span class="lang-en">Closest reference value:</span>
                                            </div>
                                            <div class="flex items-baseline">
                                                <span id="reference-value" class="text-2xl font-bold text-blue-900">129</span>
                                                <span class="text-lg ml-1 text-blue-700">°C</span>
                                            </div>
                                            <div class="text-xs text-gray-500 mt-2" id="reference-conditions">
                                                <span class="lang-ru">При SO₃: 10 ppm, H₂O: 10%</span>
                                                <span class="lang-en">At SO₃: 10 ppm, H₂O: 10%</span>
                                            </div>
                                        </div>
                                        <div class="bg-white p-3 rounded-md shadow-sm">
                                            <div class="font-medium text-blue-800 mb-1">
                                                <span class="lang-ru">Отклонение от расчетного:</span>
                                                <span class="lang-en">Deviation from calculated:</span>
                                            </div>
                                            <div class="flex items-baseline">
                                                <span id="reference-deviation" class="text-2xl font-bold text-blue-900">-1.5</span>
                                                <span class="text-lg ml-1 text-blue-700">°C</span>
                                            </div>
                                            <div class="text-xs text-gray-500 mt-2">
                                                <span id="deviation-percentage" class="font-medium">(-1.2%)</span>
                                                <span class="lang-ru"> отличие от расчетного значения</span>
                                                <span class="lang-en"> difference from calculated value</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-sm mt-3">
                                        <span class="lang-ru">Справочные данные предоставляют реальные измерения и могут отличаться от теоретических расчетов. Для критически важных расчетов рекомендуется использовать более консервативную оценку.</span>
                                        <span class="lang-en">Reference data provides real-world measurements and may differ from theoretical calculations. For critical applications, it's recommended to use the more conservative estimate.</span>
                                    </div>
                                </div>
                                
                                <!-- Comparison Results (For All Methods) -->
                                <div id="comparison-results" class="hidden mt-4">
                                    <table class="table-striped min-w-full">
                                        <thead>
                                            <tr class="bg-gray-100">
                                                <th class="px-4 py-2 text-left">
                                                    <span class="lang-ru">Метод</span>
                                                    <span class="lang-en">Method</span>
                                                </th>
                                                <th class="px-4 py-2 text-left">
                                                    <span class="lang-ru">Точка росы (°C)</span>
                                                    <span class="lang-en">Dew Point (°C)</span>
                                                </th>
                                                <th class="px-4 py-2 text-left">
                                                    <span class="lang-ru">Точка росы (°F)</span>
                                                    <span class="lang-en">Dew Point (°F)</span>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td class="px-4 py-2 font-medium">Okkes (1987)</td>
                                                <td class="px-4 py-2" id="okkes-result">130.5 °C</td>
                                                <td class="px-4 py-2" id="okkes-result-f">266.9 °F</td>
                                            </tr>
                                            <tr>
                                                <td class="px-4 py-2 font-medium">Verhoff (1974)</td>
                                                <td class="px-4 py-2" id="verhoff-result">122.3 °C</td>
                                                <td class="px-4 py-2" id="verhoff-result-f">252.1 °F</td>
                                            </tr>
                                            <tr>
                                                <td class="px-4 py-2 font-medium">ZareNezhad (2009)</td>
                                                <td class="px-4 py-2" id="zarenezhad-result">126.8 °C</td>
                                                <td class="px-4 py-2" id="zarenezhad-result-f">260.2 °F</td>
                                            </tr>
                                            <tr class="bg-blue-50">
                                                <td class="px-4 py-2 font-medium text-blue-800">
                                                    <span class="lang-ru">Максимальное значение</span>
                                                    <span class="lang-en">Maximum Value</span>
                                                </td>
                                                <td class="px-4 py-2 font-bold text-blue-800" id="max-result">130.5 °C</td>
                                                <td class="px-4 py-2 font-bold text-blue-800" id="max-result-f">266.9 °F</td>
                                            </tr>
                                            <tr class="bg-green-50">
                                                <td class="px-4 py-2 font-medium text-green-800">
                                                    <span class="lang-ru">Рекомендуемая температура</span>
                                                    <span class="lang-en">Recommended Temperature</span>
                                                </td>
                                                <td class="px-4 py-2 font-bold text-green-800" id="recommended-result">140.5 °C</td>
                                                <td class="px-4 py-2 font-bold text-green-800" id="recommended-result-f">284.9 °F</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Risk Assessment -->
                                <div class="mt-6 p-4 rounded-lg" id="risk-assessment">
                                    <h3 class="font-bold text-lg mb-2">
                                        <i class="fas fa-exclamation-triangle mr-2 text-yellow-500"></i>
                                        <span class="lang-ru">Оценка риска коррозии</span>
                                        <span class="lang-en">Corrosion Risk Assessment</span>
                                    </h3>
                                    <p id="risk-description" class="mb-2">
                                        <span class="lang-ru">При работе оборудования на температурах ниже точки росы кислоты существует риск интенсивной коррозии.</span>
                                        <span class="lang-en">Operating equipment at temperatures below the acid dew point poses a risk of intensive corrosion.</span>
                                    </p>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-3">
                                        <div class="corrosion-risk-high p-2 rounded-md text-center">
                                            <div class="font-medium">T < Tdp</div>
                                            <div class="text-sm lang-ru">Высокий риск</div>
                                            <div class="text-sm lang-en">High Risk</div>
                                        </div>
                                        <div class="corrosion-risk-medium p-2 rounded-md text-center">
                                            <div class="font-medium">Tdp < T < Tdp + 10°C</div>
                                            <div class="text-sm lang-ru">Средний риск</div>
                                            <div class="text-sm lang-en">Medium Risk</div>
                                        </div>
                                        <div class="corrosion-risk-low p-2 rounded-md text-center">
                                            <div class="font-medium">T > Tdp + 10°C</div>
                                            <div class="text-sm lang-ru">Низкий риск</div>
                                            <div class="text-sm lang-en">Low Risk</div>
                                        </div>
                                    </div>
                                    
                                    <!-- Enhanced Corrosion Rate Information -->
                                    <div class="mt-4 p-3 bg-gray-50 rounded-md" id="corrosion-rate-info">
                                        <h4 class="font-bold text-md mb-2">
                                            <i class="fas fa-tachometer-alt mr-2 text-red-600"></i>
                                            <span class="lang-ru">Прогнозируемая скорость коррозии</span>
                                            <span class="lang-en">Predicted Corrosion Rate</span>
                                        </h4>
                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                                            <div class="bg-white p-2 rounded-md shadow-sm">
                                                <div class="text-sm font-medium">
                                                    <span class="lang-ru">Углеродистая сталь:</span>
                                                    <span class="lang-en">Carbon Steel:</span>
                                </div>
                                                <div class="flex items-baseline">
                                                    <span id="carbon-steel-rate" class="text-lg font-bold text-red-700">20.0</span>
                                                    <span class="text-xs ml-1 text-gray-700">мг/см²/час</span>
                                                </div>
                                                <div class="text-xs text-gray-600 mt-1">
                                                    <span class="lang-ru">Очень высокая скорость</span>
                                                    <span class="lang-en">Very high rate</span>
                                                </div>
                                            </div>
                                            <div class="bg-white p-2 rounded-md shadow-sm">
                                                <div class="text-sm font-medium">
                                                    <span class="lang-ru">Нерж. сталь 304:</span>
                                                    <span class="lang-en">SS 304:</span>
                                                </div>
                                                <div class="flex items-baseline">
                                                    <span id="ss304-rate" class="text-lg font-bold text-orange-600">1.0</span>
                                                    <span class="text-xs ml-1 text-gray-700">мг/см²/час</span>
                                                </div>
                                                <div class="text-xs text-gray-600 mt-1">
                                                    <span class="lang-ru">Средняя скорость</span>
                                                    <span class="lang-en">Moderate rate</span>
                                                </div>
                                            </div>
                                            <div class="bg-white p-2 rounded-md shadow-sm">
                                                <div class="text-sm font-medium">
                                                    <span class="lang-ru">Нерж. сталь 316L:</span>
                                                    <span class="lang-en">SS 316L:</span>
                                                </div>
                                                <div class="flex items-baseline">
                                                    <span id="ss316l-rate" class="text-lg font-bold text-green-600">0.2</span>
                                                    <span class="text-xs ml-1 text-gray-700">мг/см²/час</span>
                                                </div>
                                                <div class="text-xs text-gray-600 mt-1">
                                                    <span class="lang-ru">Низкая скорость</span>
                                                    <span class="lang-en">Low rate</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="text-xs text-gray-500 mt-2">
                                            <span class="lang-ru">* Скорость коррозии указана для выбранных условий и может значительно отличаться в зависимости от температуры и концентрации кислоты.</span>
                                            <span class="lang-en">* Corrosion rate is shown for the selected conditions and may vary significantly depending on temperature and acid concentration.</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Graph Card -->
                        <div class="card p-6">
                            <h2 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">
                                <i class="fas fa-chart-line mr-2 text-blue-600"></i>
                                <span class="lang-ru">Графический анализ</span>
                                <span class="lang-en">Graphical Analysis</span>
                            </h2>
                            
                            <!-- Graph Controls -->
                            <div class="flex flex-wrap gap-2 mb-4">
                                <button id="graph-type-h2o" class="graph-type-btn btn-primary py-1 px-3 rounded-md text-sm">
                                    <span class="lang-ru">Зависимость от H₂O</span>
                                    <span class="lang-en">H₂O Dependence</span>
                                </button>
                                <button id="graph-type-acid" class="graph-type-btn bg-gray-200 text-gray-700 py-1 px-3 rounded-md text-sm">
                                    <span class="lang-ru">Зависимость от кислоты</span>
                                    <span class="lang-en">Acid Dependence</span>
                                </button>
                                <button id="graph-type-pressure" class="graph-type-btn bg-gray-200 text-gray-700 py-1 px-3 rounded-md text-sm">
                                    <span class="lang-ru">Зависимость от давления</span>
                                    <span class="lang-en">Pressure Dependence</span>
                                </button>
                                <button id="graph-type-compare" class="graph-type-btn bg-gray-200 text-gray-700 py-1 px-3 rounded-md text-sm">
                                    <span class="lang-ru">Сравнение методов</span>
                                    <span class="lang-en">Method Comparison</span>
                                </button>
                            </div>
                            
                            <!-- Graph Canvas -->
                            <div class="bg-white border rounded-lg p-2" style="height: 400px;">
                                <canvas id="dewPointChart"></canvas>
                            </div>
                            
                            <!-- Graph Description -->
                            <div class="mt-4 text-sm text-gray-600" id="graph-description">
                                <p class="lang-ru">График показывает зависимость точки росы от содержания воды (H₂O) при фиксированных значениях других параметров.</p>
                                <p class="lang-en">The graph shows the dependence of dew point on water content (H₂O) while other parameters remain fixed.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reference Data Tab Content -->
            <div id="reference-data" class="tab-content fade-in" style="display: none;">
                <div class="grid grid-cols-1 gap-6">
                    <!-- Reference Data Navigation -->
                    <div class="card p-4 mb-4">
                        <div class="flex flex-wrap mb-4">
                            <button id="ref-h2so4-btn" class="ref-data-btn btn-primary py-1 px-3 rounded-md text-sm mr-2">
                                <span class="lang-ru">Данные H₂SO₄</span>
                                <span class="lang-en">H₂SO₄ Data</span>
                            </button>
                            <button id="ref-hcl-btn" class="ref-data-btn bg-gray-200 text-gray-700 py-1 px-3 rounded-md text-sm mr-2">
                                <span class="lang-ru">Данные HCl</span>
                                <span class="lang-en">HCl Data</span>
                            </button>
                            <button id="ref-corrosion-btn" class="ref-data-btn bg-gray-200 text-gray-700 py-1 px-3 rounded-md text-sm">
                                <span class="lang-ru">Данные коррозии</span>
                                <span class="lang-en">Corrosion Data</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- H2SO4 Reference Data -->
                    <div id="ref-h2so4-data" class="card p-6">
                        <h2 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">
                            <i class="fas fa-table mr-2 text-blue-600"></i>
                            <span class="lang-ru">Таблица точек росы серной кислоты для газа типа SO₃-H₂O</span>
                            <span class="lang-en">Sulfuric Acid Dew Point Table for SO₃-H₂O Gas</span>
                        </h2>
                        
                        <div class="overflow-x-auto">
                            <table class="table-auto min-w-full border-collapse">
                                <thead class="bg-blue-50">
                                    <tr>
                                        <th class="border px-4 py-2">
                                            <span class="lang-ru">SO₃ (ppm)</span>
                                            <span class="lang-en">SO₃ (ppm)</span>
                                        </th>
                                        <th class="border px-4 py-2">5% H₂O</th>
                                        <th class="border px-4 py-2">10% H₂O</th>
                                        <th class="border px-4 py-2">15% H₂O</th>
                                        <th class="border px-4 py-2">20% H₂O</th>
                                        <th class="border px-4 py-2">25% H₂O</th>
                                        <th class="border px-4 py-2">30% H₂O</th>
                                    </tr>
                                </thead>
                                <tbody id="h2so4-table-body">
                                    <!-- Table will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-6">
                            <h3 class="text-lg font-semibold mb-3">
                                <span class="lang-ru">Визуализация данных</span>
                                <span class="lang-en">Data Visualization</span>
                            </h3>
                            <div class="bg-white border rounded-lg p-2" style="height: 400px;">
                                <canvas id="h2so4HeatmapChart"></canvas>
                            </div>
                            <p class="text-sm text-gray-600 mt-2">
                                <span class="lang-ru">Цветовая карта показывает точку росы (°C) в зависимости от содержания SO₃ и влажности H₂O.</span>
                                <span class="lang-en">The heatmap shows dew point (°C) as a function of SO₃ content and H₂O humidity.</span>
                            </p>
                        </div>
                    </div>

                    <!-- HCl Reference Data -->
                    <div id="ref-hcl-data" class="card p-6 hidden">
                        <h2 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">
                            <i class="fas fa-table mr-2 text-green-600"></i>
                            <span class="lang-ru">Таблица точек росы соляной кислоты для газа типа HCl-H₂O</span>
                            <span class="lang-en">Hydrochloric Acid Dew Point Table for HCl-H₂O Gas</span>
                        </h2>
                        
                        <div class="overflow-x-auto">
                            <table class="table-auto min-w-full border-collapse">
                                <thead class="bg-green-50">
                                    <tr>
                                        <th class="border px-4 py-2">
                                            <span class="lang-ru">HCl (ppm)</span>
                                            <span class="lang-en">HCl (ppm)</span>
                                        </th>
                                        <th class="border px-4 py-2">5% H₂O</th>
                                        <th class="border px-4 py-2">10% H₂O</th>
                                        <th class="border px-4 py-2">15% H₂O</th>
                                        <th class="border px-4 py-2">20% H₂O</th>
                                        <th class="border px-4 py-2">25% H₂O</th>
                                        <th class="border px-4 py-2">30% H₂O</th>
                                    </tr>
                                </thead>
                                <tbody id="hcl-table-body">
                                    <!-- Table will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-6">
                            <h3 class="text-lg font-semibold mb-3">
                                <span class="lang-ru">Визуализация данных</span>
                                <span class="lang-en">Data Visualization</span>
                            </h3>
                            <div class="bg-white border rounded-lg p-2" style="height: 400px;">
                                <canvas id="hclHeatmapChart"></canvas>
                            </div>
                            <p class="text-sm text-gray-600 mt-2">
                                <span class="lang-ru">Цветовая карта показывает точку росы (°C) в зависимости от содержания HCl и влажности H₂O.</span>
                                <span class="lang-en">The heatmap shows dew point (°C) as a function of HCl content and H₂O humidity.</span>
                            </p>
                        </div>
                    </div>

                    <!-- Corrosion Data -->
                    <div id="ref-corrosion-data" class="card p-6 hidden">
                        <h2 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">
                            <i class="fas fa-table mr-2 text-red-600"></i>
                            <span class="lang-ru">Данные скорости коррозии для разных материалов</span>
                            <span class="lang-en">Corrosion Rate Data for Different Materials</span>
                        </h2>
                        
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold mb-3">
                                <span class="lang-ru">Скорость коррозии (HCl)</span>
                                <span class="lang-en">Corrosion Rate (HCl)</span>
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <h4 class="font-medium text-gray-700 mb-2">
                                        <span class="lang-ru">40°C</span>
                                        <span class="lang-en">40°C</span>
                                    </h4>
                                    <table class="table-auto w-full border-collapse">
                                        <thead class="bg-red-50">
                                            <tr>
                                                <th class="border px-3 py-1 text-sm">
                                                    <span class="lang-ru">Материал</span>
                                                    <span class="lang-en">Material</span>
                                                </th>
                                                <th class="border px-3 py-1 text-sm">3% HCl</th>
                                                <th class="border px-3 py-1 text-sm">10% HCl</th>
                                                <th class="border px-3 py-1 text-sm">20% HCl</th>
                                            </tr>
                                        </thead>
                                        <tbody id="corrosion-table-body-40c">
                                            <!-- Table will be populated by JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                                <div>
                                    <h4 class="font-medium text-gray-700 mb-2">
                                        <span class="lang-ru">80°C</span>
                                        <span class="lang-en">80°C</span>
                                    </h4>
                                    <table class="table-auto w-full border-collapse">
                                        <thead class="bg-red-50">
                                            <tr>
                                                <th class="border px-3 py-1 text-sm">
                                                    <span class="lang-ru">Материал</span>
                                                    <span class="lang-en">Material</span>
                                                </th>
                                                <th class="border px-3 py-1 text-sm">3% HCl</th>
                                                <th class="border px-3 py-1 text-sm">10% HCl</th>
                                                <th class="border px-3 py-1 text-sm">20% HCl</th>
                                            </tr>
                                        </thead>
                                        <tbody id="corrosion-table-body-80c">
                                            <!-- Table will be populated by JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-6">
                            <h3 class="text-lg font-semibold mb-3">
                                <span class="lang-ru">Визуализация данных</span>
                                <span class="lang-en">Data Visualization</span>
                            </h3>
                            <div class="bg-white border rounded-lg p-2" style="height: 400px;">
                                <canvas id="corrosionRateChart"></canvas>
                            </div>
                            <p class="text-sm text-gray-600 mt-2">
                                <span class="lang-ru">График показывает скорость коррозии (мг/см²/час) для разных материалов при различных концентрациях HCl и температурах.</span>
                                <span class="lang-en">The chart shows corrosion rate (mg/cm²/hour) for different materials at various HCl concentrations and temperatures.</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Theory Tab Content -->
            <div id="theory" class="tab-content fade-in" style="display: none;">
                <div class="card p-6 mb-6">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">
                        <i class="fas fa-book mr-2 text-blue-600"></i>
                        <span class="lang-ru">Теория и формулы</span>
                        <span class="lang-en">Theory & Formulas</span>
                    </h2>
                    
                    <div class="mb-6">
                        <h3 class="text-xl font-semibold mb-3 text-gray-700">
                            <span class="lang-ru">Что такое кислотная точка росы?</span>
                            <span class="lang-en">What is Acid Dew Point?</span>
                        </h3>
                        <p class="mb-3 lang-ru">
                            Температура кислотной точки росы – это температура, при которой пары кислот в газовой смеси начинают конденсироваться в жидкую фазу. В контексте дымовых и технологических газов это обычно относится к конденсации кислых компонентов, таких как серная кислота (H₂SO₄), соляная кислота (HCl) или сероводород (H₂S), на холодных поверхностях.
                        </p>
                        <p class="mb-3 lang-en">
                            Acid dew point temperature is the temperature at which acid vapors in a gas mixture begin to condense into liquid phase. In the context of flue and process gases, this usually refers to the condensation of acidic components such as sulfuric acid (H₂SO₄), hydrochloric acid (HCl), or hydrogen sulfide (H₂S) on cold surfaces.
                        </p>
                        <p class="mb-3 lang-ru">
                            Конденсация даже небольших количеств этих кислот может значительно повысить точку росы газа – например, при содержании SO₃ порядка 0,005% об. и 10% H₂O точка росы газов достигает ~150 °С, тогда как точка росы чистого водяного пара при тех же условиях составляет около 45-50 °С.
                        </p>
                        <p class="mb-3 lang-en">
                            Condensation of even small amounts of these acids can significantly raise the dew point of the gas - for example, with SO₃ content of about 0.005% vol. and 10% H₂O, the gas dew point reaches ~150 °C, while the dew point of pure water vapor under the same conditions is about 45-50 °C.
                        </p>
                    </div>
                    
                    <!-- H2SO4 Section -->
                    <div class="mb-6">
                        <h3 class="text-xl font-semibold mb-3 text-blue-700">
                            <span class="lang-ru">Расчет точки росы серной кислоты (H₂SO₄)</span>
                            <span class="lang-en">Sulfuric Acid (H₂SO₄) Dew Point Calculation</span>
                        </h3>
                        
                        <div class="mb-4">
                            <h4 class="font-medium mb-2">
                                <span class="lang-ru">Формула Verhoff & Banchero (1974)</span>
                                <span class="lang-en">Verhoff & Banchero Formula (1974)</span>
                            </h4>
                            <div class="equation">
                                \frac{1000}{T} = 2.276 - 0.02943\ln(p_{H_{2}O}) - 0.0858\ln(p_{SO_{3}}) + 0.0062\ln(p_{H_{2}O})\ln(p_{SO_{3}})
                            </div>
                            <p class="text-sm text-gray-600 mt-2 lang-ru">
                                где T – температура точки росы в К, p<sub>H₂O</sub> и p<sub>SO₃</sub> – парциальные давления H₂O и SO₃ (в мм рт.ст.).
                            </p>
                            <p class="text-sm text-gray-600 mt-2 lang-en">
                                where T is the dew point temperature in K, p<sub>H₂O</sub> and p<sub>SO₃</sub> are the partial pressures of H₂O and SO₃ (in mmHg).
                            </p>
                        </div>
                        
                        <div class="mb-4">
                            <h4 class="font-medium mb-2">
                                <span class="lang-ru">Формула Okkes (1987)</span>
                                <span class="lang-en">Okkes Formula (1987)</span>
                            </h4>
                            <div class="equation">
                                T_{росы}^{H_{2}SO_{4}} (°C) = 203.25 + 27.6\log_{10}(p_{H_{2}O}) + 10.83\log_{10}(p_{SO_{3}}) + 1.06[\log_{10}(p_{SO_{3}}) + 8]^{2.19}
                            </div>
                            <p class="text-sm text-gray-600 mt-2 lang-ru">
                                где p<sub>H₂O</sub> и p<sub>SO₃</sub> – объёмные доли H₂O и SO₃ (безразмерные величины).
                            </p>
                            <p class="text-sm text-gray-600 mt-2 lang-en">
                                where p<sub>H₂O</sub> and p<sub>SO₃</sub> are the volume fractions of H₂O and SO₃ (dimensionless).
                            </p>
                        </div>
                        
                        <div class="mb-4">
                            <h4 class="font-medium mb-2">
                                <span class="lang-ru">Формула ZareNezhad (2009)</span>
                                <span class="lang-en">ZareNezhad Formula (2009)</span>
                            </h4>
                            <div class="equation">
                                T_{росы}^{H_{2}SO_{4}} (°C) = 150 + 8.1328\ln(p_{H_{2}O}) + 11.664\ln(p_{SO_{3}}) - 0.38226\ln(p_{H_{2}O})\ln(p_{SO_{3}})
                            </div>
                            <p class="text-sm text-gray-600 mt-2 lang-ru">
                                где p<sub>H₂O</sub> и p<sub>SO₃</sub> – парциальные давления в мм рт.ст.
                            </p>
                            <p class="text-sm text-gray-600 mt-2 lang-en">
                                where p<sub>H₂O</sub> and p<sub>SO₃</sub> are the partial pressures in mmHg.
                            </p>
                        </div>
                    </div>
                    
                    <!-- HCl Section -->
                    <div class="mb-6">
                        <h3 class="text-xl font-semibold mb-3 text-green-700">
                            <span class="lang-ru">Расчет точки росы соляной кислоты (HCl)</span>
                            <span class="lang-en">Hydrochloric Acid (HCl) Dew Point Calculation</span>
                        </h3>
                        
                        <div class="mb-4">
                            <h4 class="font-medium mb-2">
                                <span class="lang-ru">Формула Kiang (1981)</span>
                                <span class="lang-en">Kiang Formula (1981)</span>
                            </h4>
                            <div class="equation">
                                \frac{1000}{T} = 3.7368 - 0.1591\ln(p_{H_{2}O}) - 0.0326\ln(p_{HCl}) + 0.00269\ln(p_{H_{2}O})\ln(p_{HCl})
                            </div>
                            <p class="text-sm text-gray-600 mt-2 lang-ru">
                                где T – температура в K, p<sub>H₂O</sub> и p<sub>HCl</sub> – парциальные давления воды и HCl в мм рт.ст.
                            </p>
                            <p class="text-sm text-gray-600 mt-2 lang-en">
                                where T is temperature in K, p<sub>H₂O</sub> and p<sub>HCl</sub> are the partial pressures of water and HCl in mmHg.
                            </p>
                        </div>
                    </div>
                    
                    <!-- H2S Section -->
                    <div class="mb-6">
                        <h3 class="text-xl font-semibold mb-3 text-purple-700">
                            <span class="lang-ru">Расчет точки росы сероводорода (H₂S)</span>
                            <span class="lang-en">Hydrogen Sulfide (H₂S) Dew Point Calculation</span>
                        </h3>
                        
                        <div class="mb-4">
                            <h4 class="font-medium mb-2">
                                <span class="lang-ru">Уравнение Антуана (по данным NIST)</span>
                                <span class="lang-en">Antoine Equation (NIST data)</span>
                            </h4>
                            <p class="mb-2 lang-ru">
                                Для расчета используется уравнение Антуана, которое связывает давление насыщенного пара с температурой:
                            </p>
                            <p class="mb-2 lang-en">
                                The Antoine equation is used for calculation, which relates saturated vapor pressure to temperature:
                            </p>
                            <div class="equation">
                                \log_{10}P(\text{бар}) = 4.52887 - \frac{958.587}{T(K) - 0.539}
                            </div>
                            <p class="text-sm text-gray-600 mt-2 lang-ru">
                                Действительно для диапазона температур 212.8–349.5 K (от -60.3 °С до +76.4 °С).
                            </p>
                            <p class="text-sm text-gray-600 mt-2 lang-en">
                                Valid for temperature range 212.8–349.5 K (from -60.3 °C to +76.4 °C).
                            </p>
                        </div>
                    </div>
                    
                    <!-- Conversion Section -->
                    <div class="mb-6">
                        <h3 class="text-xl font-semibold mb-3 text-gray-700">
                            <span class="lang-ru">Пересчет единиц измерения</span>
                            <span class="lang-en">Unit Conversion</span>
                        </h3>
                        
                        <div class="mb-4">
                            <h4 class="font-medium mb-2">
                                <span class="lang-ru">Перевод % или ppm в парциальное давление</span>
                                <span class="lang-en">Converting % or ppm to partial pressure</span>
                            </h4>
                            <p class="mb-2 lang-ru">
                                • 1% об. = 0.01 (безразмерно) = 0.01 атм при 1 атм общего давления (≈7.6 мм рт.ст.)<br>
                                • 1 ppm = 1×10⁻⁶ доля = 1×10⁻⁶ атм (≈0.00076 мм рт.ст.)
                            </p>
                            <p class="mb-2 lang-en">
                                • 1% vol. = 0.01 (dimensionless) = 0.01 atm at 1 atm total pressure (≈7.6 mmHg)<br>
                                • 1 ppm = 1×10⁻⁶ fraction = 1×10⁻⁶ atm (≈0.00076 mmHg)
                            </p>
                        </div>
                        
                        <div class="mb-4">
                            <h4 class="font-medium mb-2">
                                <span class="lang-ru">Перевод единиц давления</span>
                                <span class="lang-en">Pressure unit conversion</span>
                            </h4>
                            <p class="mb-2 lang-ru">
                                • 1 атм = 760 мм рт.ст. = 1.01325 бар = 101.325 кПа<br>
                                • 1 бар = 750.06 мм рт.ст. = 0.986923 атм = 100 кПа<br>
                                • 1 кПа = 7.50062 мм рт.ст. = 0.00986923 атм = 0.01 бар
                            </p>
                            <p class="mb-2 lang-en">
                                • 1 atm = 760 mmHg = 1.01325 bar = 101.325 kPa<br>
                                • 1 bar = 750.06 mmHg = 0.986923 atm = 100 kPa<br>
                                • 1 kPa = 7.50062 mmHg = 0.00986923 atm = 0.01 bar
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recommendations Tab Content -->
            <div id="recommendations" class="tab-content fade-in" style="display: none;">
                <div class="card p-6 mb-6">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">
                        <i class="fas fa-shield-alt mr-2 text-blue-600"></i>
                        <span class="lang-ru">Рекомендации по предотвращению коррозии</span>
                        <span class="lang-en">Corrosion Prevention Recommendations</span>
                    </h2>
                    
                    <div class="mb-6">
                        <h3 class="text-xl font-semibold mb-3 text-gray-700">
                            <span class="lang-ru">Общие принципы</span>
                            <span class="lang-en">General Principles</span>
                        </h3>
                        <ul class="list-disc ml-6 space-y-2">
                            <li class="lang-ru">
                                <strong>Температурный режим:</strong> Поддерживайте температуру поверхностей оборудования выше точки росы кислоты с запасом не менее 10°C.
                            </li>
                            <li class="lang-en">
                                <strong>Temperature control:</strong> Maintain equipment surface temperatures above the acid dew point with a margin of at least 10°C.
                            </li>
                            <li class="lang-ru">
                                <strong>Мониторинг:</strong> Регулярно контролируйте состав газа, особенно содержание SO₃, HCl и H₂O, для своевременного обнаружения изменений, которые могут повлиять на точку росы.
                            </li>
                            <li class="lang-en">
                                <strong>Monitoring:</strong> Regularly monitor gas composition, especially SO₃, HCl, and H₂O content, to detect changes that may affect the dew point.
                            </li>
                            <li class="lang-ru">
                                <strong>Теплоизоляция:</strong> Используйте качественную теплоизоляцию для предотвращения локального охлаждения поверхностей ниже точки росы.
                            </li>
                            <li class="lang-en">
                                <strong>Thermal insulation:</strong> Use high-quality thermal insulation to prevent local cooling of surfaces below the dew point.
                            </li>
                        </ul>
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="text-xl font-semibold mb-3 text-gray-700">
                            <span class="lang-ru">Материалы и покрытия</span>
                            <span class="lang-en">Materials and Coatings</span>
                        </h3>
                        
                        <h4 class="font-medium mb-2 text-blue-700">
                            <span class="lang-ru">Для защиты от серной кислоты (H₂SO₄)</span>
                            <span class="lang-en">For sulfuric acid (H₂SO₄) protection</span>
                        </h4>
                        <ul class="list-disc ml-6 space-y-1 mb-4">
                            <li class="lang-ru">
                                <strong>Нержавеющие стали:</strong> Используйте стали марок 316L, 317L или специальные сплавы с содержанием молибдена.
                            </li>
                            <li class="lang-en">
                                <strong>Stainless steels:</strong> Use 316L, 317L grades or special alloys with molybdenum content.
                            </li>
                            <li class="lang-ru">
                                <strong>Никелевые сплавы:</strong> Хастеллой (Hastelloy), Инконель (Inconel) для особо агрессивных условий.
                            </li>
                            <li class="lang-en">
                                <strong>Nickel alloys:</strong> Hastelloy, Inconel for particularly aggressive conditions.
                            </li>
                            <li class="lang-ru">
                                <strong>Покрытия:</strong> Фторполимерные покрытия (PTFE, PFA), эмали, стеклоэмалевые покрытия.
                            </li>
                            <li class="lang-en">
                                <strong>Coatings:</strong> Fluoropolymer coatings (PTFE, PFA), enamels, glass-enamel coatings.
                            </li>
                        </ul>
                        
                        <h4 class="font-medium mb-2 text-green-700">
                            <span class="lang-ru">Для защиты от соляной кислоты (HCl)</span>
                            <span class="lang-en">For hydrochloric acid (HCl) protection</span>
                        </h4>
                        <ul class="list-disc ml-6 space-y-1 mb-4">
                            <li class="lang-ru">
                                <strong>Специальные стали:</strong> S-TEN™ и другие хлоридостойкие марки.
                            </li>
                            <li class="lang-en">
                                <strong>Special steels:</strong> S-TEN™ and other chloride-resistant grades.
                            </li>
                            <li class="lang-ru">
                                <strong>Полимерные материалы:</strong> FRP (стеклопластик), CPVC, полипропилен.
                            </li>
                            <li class="lang-en">
                                <strong>Polymer materials:</strong> FRP (fiberglass reinforced plastic), CPVC, polypropylene.
                            </li>
                            <li class="lang-ru">
                                <strong>Титановые сплавы:</strong> Для особо ответственных применений.
                            </li>
                            <li class="lang-en">
                                <strong>Titanium alloys:</strong> For critical applications.
                            </li>
                        </ul>
                        
                        <h4 class="font-medium mb-2 text-purple-700">
                            <span class="lang-ru">Для защиты от сероводорода (H₂S)</span>
                            <span class="lang-en">For hydrogen sulfide (H₂S) protection</span>
                        </h4>
                        <ul class="list-disc ml-6 space-y-1">
                            <li class="lang-ru">
                                <strong>Влагоустойчивые стали:</strong> Сплавы, устойчивые к сульфидному растрескиванию (SSC).
                            </li>
                            <li class="lang-en">
                                <strong>Moisture-resistant steels:</strong> Alloys resistant to sulfide stress cracking (SSC).
                            </li>
                            <li class="lang-ru">
                                <strong>Осушка газа:</strong> Поддержание температуры выше точки росы воды для предотвращения образования влажного H₂S.
                            </li>
                            <li class="lang-en">
                                <strong>Gas drying:</strong> Maintaining temperature above the water dew point to prevent the formation of wet H₂S.
                            </li>
                        </ul>
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="text-xl font-semibold mb-3 text-gray-700">
                            <span class="lang-ru">Инженерные решения</span>
                            <span class="lang-en">Engineering Solutions</span>
                        </h3>
                        <ul class="list-disc ml-6 space-y-2">
                            <li class="lang-ru">
                                <strong>Конструктивные меры:</strong> Проектирование оборудования с учетом возможности дренажа конденсата, избегание застойных зон.
                            </li>
                            <li class="lang-en">
                                <strong>Design measures:</strong> Equipment design with possibility for condensate drainage, avoiding stagnant zones.
                            </li>
                            <li class="lang-ru">
                                <strong>Подогрев:</strong> Использование обогрева труб и оборудования для поддержания температуры выше точки росы.
                            </li>
                            <li class="lang-en">
                                <strong>Heating:</strong> Use of pipe and equipment heating to maintain temperature above the dew point.
                            </li>
                            <li class="lang-ru">
                                <strong>Кондиционирование газа:</strong> Снижение содержания кислотообразующих компонентов (SO₃, HCl) с помощью скрубберов или фильтров.
                            </li>
                            <li class="lang-en">
                                <strong>Gas conditioning:</strong> Reduction of acid-forming components (SO₃, HCl) using scrubbers or filters.
                            </li>
                            <li class="lang-ru">
                                <strong>Полимерные теплообменники:</strong> Использование теплообменников из коррозионностойких полимеров для рекуперации тепла в зоне конденсации кислот.
                            </li>
                            <li class="lang-en">
                                <strong>Polymer heat exchangers:</strong> Use of heat exchangers made from corrosion-resistant polymers for heat recovery in the acid condensation zone.
                            </li>
                        </ul>
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="text-xl font-semibold mb-3 text-gray-700">
                            <span class="lang-ru">Практические запасы</span>
                            <span class="lang-en">Practical Margins</span>
                        </h3>
                        <p class="mb-3 lang-ru">
                            Инженерные рекомендации по эксплуатации оборудования обычно советуют иметь запас по температуре над рассчитанной точкой росы. Часто применяют дополнительный запас ≥10 °С сверх вычисленной кислотной точки росы.
                        </p>
                        <p class="mb-3 lang-en">
                            Engineering recommendations for equipment operation usually advise having a temperature margin above the calculated dew point. An additional margin of ≥10 °C above the calculated acid dew point is often applied.
                        </p>
                        <p class="mb-3 lang-ru">
                            Это учитывает неточности формул, возможные колебания состава (например, всплески SO₃) и неравномерность температур поверхности. Таким образом, если расчет дал Tₑ=130 °С, то газы стараются охлаждать не ниже ~140 °С.
                        </p>
                        <p class="mb-3 lang-en">
                            This accounts for formula inaccuracies, possible composition fluctuations (for example, SO₃ spikes), and surface temperature non-uniformity. Thus, if the calculation gave Tₑ=130 °С, the gases are kept above ~140 °С.
                        </p>
                    </div>
                </div>
            </div>

            <!-- References Tab Content -->
            <div id="references" class="tab-content fade-in" style="display: none;">
                <div class="card p-6 mb-6">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">
                        <i class="fas fa-book-open mr-2 text-blue-600"></i>
                        <span class="lang-ru">Источники и литература</span>
                        <span class="lang-en">References and Literature</span>
                    </h2>
                    
                    <div class="mb-6">
                        <h3 class="text-xl font-semibold mb-3 text-gray-700">
                            <span class="lang-ru">Научные публикации</span>
                            <span class="lang-en">Scientific Publications</span>
                        </h3>
                        <ol class="list-decimal ml-6 space-y-3">
                            <li>
                                Verhoff F.H., Banchero J.T. (1974). "Predicting Dew Points of Gases", Chemical Engineering Progress 70(8), 71-72.
                            </li>
                            <li>
                                Okkes A.G. (1987). "Get Acid Dew Point of Flue Gas", Hydrocarbon Processing, July 1987, 53-55.
                            </li>
                            <li>
                                Kiang Y.H. (1981). "Predicting Dewpoints of Gases", Chemical Engineering 88(3), 127-128.
                            </li>
                            <li>
                                ZareNezhad M. (2009). "A new equation for acid dew-point", Chemical Engineering & Technology 32(4), 585-587.
                            </li>
                            <li>
                                Pierce R.R. (1977). "Estimating Acid Dewpoints in Stack Gases", Chemical Engineering, 84(8), 125-128.
                            </li>
                            <li>
                                Ganapathy V. (1993). "Steam Plant Calculations Manual", 2nd Edition, CRC Press, New York.
                            </li>
                        </ol>
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="text-xl font-semibold mb-3 text-gray-700">
                            <span class="lang-ru">Технические источники</span>
                            <span class="lang-en">Technical Sources</span>
                        </h3>
                        <ol class="list-decimal ml-6 space-y-3">
                            <li>
                                <span class="lang-ru">HeatMatrix Group B.V. - Технические статьи по низкотемпературной коррозии</span>
                                <span class="lang-en">HeatMatrix Group B.V. - Technical articles on low-temperature corrosion</span>
                                <br>
                                <a href="https://heatmatrixgroup.com/knowledge-center/how-to-calculate-the-acid-dew-point-adp-of-flue-gas/" class="text-blue-600 hover:underline" target="_blank">https://heatmatrixgroup.com/knowledge-center/how-to-calculate-the-acid-dew-point-adp-of-flue-gas/</a>
                            </li>
                            <li>
                                <span class="lang-ru">NIST Chemistry WebBook - Данные давления насыщения H₂S</span>
                                <span class="lang-en">NIST Chemistry WebBook - H₂S saturation pressure data</span>
                                <br>
                                <a href="https://webbook.nist.gov/cgi/cbook.cgi?ID=C7783064&Units=SI&Mask=4#Thermo-Phase" class="text-blue-600 hover:underline" target="_blank">https://webbook.nist.gov/cgi/cbook.cgi?ID=C7783064</a>
                            </li>
                            <li>
                                <span class="lang-ru">Nippon Steel, каталог S-TEN™ - Описание коррозии при кислотной точке росы</span>
                                <span class="lang-en">Nippon Steel, S-TEN™ catalog - Description of acid dew point corrosion</span>
                                <br>
                                <a href="https://www.nipponsteel.com/product/catalog_download/pdf/A012en.pdf" class="text-blue-600 hover:underline" target="_blank">https://www.nipponsteel.com/product/catalog_download/pdf/A012en.pdf</a>
                            </li>
                            <li>
                                <span class="lang-ru">ECOONEX B.V. - Калькулятор точки росы кислоты</span>
                                <span class="lang-en">ECOONEX B.V. - Acid Dew Point Calculator</span>
                                <br>
                                <a href="https://ecoonex.com/acid-dew-point/" class="text-blue-600 hover:underline" target="_blank">https://ecoonex.com/acid-dew-point/</a>
                            </li>
                            <li>
                                <span class="lang-ru">Envitech, Inc. - Формулы расчета точки росы кислотных газов</span>
                                <span class="lang-en">Envitech, Inc. - Acid Gas Dewpoint Formulas</span>
                                <br>
                                <a href="https://www.envitechinc.com/air-pollution-control-innovations/bid/20805/Acid-Gas-Dewpoint" class="text-blue-600 hover:underline" target="_blank">https://www.envitechinc.com/air-pollution-control-innovations/bid/20805/Acid-Gas-Dewpoint</a>
                            </li>
                        </ol>
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="text-xl font-semibold mb-3 text-gray-700">
                            <span class="lang-ru">Стандарты и руководства</span>
                            <span class="lang-en">Standards and Guidelines</span>
                        </h3>
                        <ol class="list-decimal ml-6 space-y-3">
                            <li>
                                <span class="lang-ru">EPRI (Electric Power Research Institute) - Руководства по предотвращению холодной коррозии</span>
                                <span class="lang-en">EPRI (Electric Power Research Institute) - Guidelines for Cold End Corrosion Prevention</span>
                            </li>
                            <li>
                                <span class="lang-ru">API (American Petroleum Institute) - Стандарты по защите от коррозии оборудования нефтепереработки</span>
                                <span class="lang-en">API (American Petroleum Institute) - Standards for Corrosion Protection of Refinery Equipment</span>
                            </li>
                            <li>
                                <span class="lang-ru">VGB (Verband der Großkessel-Besitzer) - Руководства по эксплуатации котельного оборудования</span>
                                <span class="lang-en">VGB (Verband der Großkessel-Besitzer) - Guidelines for Boiler Equipment Operation</span>
                            </li>
                        </ol>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="mt-8 text-center text-gray-600 text-sm">
            <p class="lang-ru">Калькулятор точки росы кислотной коррозии. Разработан на основе научных формул и данных.</p>
            <p class="lang-en">Acid Dew Point Corrosion Calculator. Developed based on scientific formulas and data.</p>
            <p class="mt-1">© 2023</p>
        </footer>
    </div>

    <!-- JavaScript -->
    <script>
        // Global variables
let currentAcid = 'h2so4';
let currentMethod = 'okkes';
let currentGraphType = 'h2o';
let dewPointChart = null;
let currentLanguage = 'ru';

// Function to set language
function setLanguage(lang) {
    currentLanguage = lang;
    
    // Toggle language display
    document.querySelectorAll('.lang-ru').forEach(el => {
        el.style.display = lang === 'ru' ? 'inline-block' : 'none';
    });
    
    document.querySelectorAll('.lang-en').forEach(el => {
        el.style.display = lang === 'en' ? 'inline-block' : 'none';
    });
    
    document.documentElement.lang = lang;
    
    // Update unit labels
    updateUnitLabels();
    
    // Update dynamically generated content if needed
    updateDynamicContent();
}

// Update unit display texts for each language
function updateUnitLabels() {
    // Update percent display in all unit selectors
    document.querySelectorAll('option[value="percent"]').forEach(option => {
        option.textContent = currentLanguage === 'ru' ? '% об.' : '% vol.';
    });
    
    // Update atm display in all unit selectors
    document.querySelectorAll('option[value="atm"]').forEach(option => {
        option.textContent = currentLanguage === 'ru' ? 'атм' : 'atm';
    });
    
    // Update mmHg display in all unit selectors
    document.querySelectorAll('option[value="mmHg"]').forEach(option => {
        option.textContent = currentLanguage === 'ru' ? 'мм рт.ст.' : 'mmHg';
    });
    
    // Update mg/nm3 display in all unit selectors  
    document.querySelectorAll('option[value="mg/nm3"]').forEach(option => {
        option.textContent = currentLanguage === 'ru' ? 'мг/нм³' : 'mg/nm³';
    });
}

// Function to update dynamically generated content
function updateDynamicContent() {
    // Update all dynamically generated content that needs language-specific text
    
    // Update intermediate values units if they exist
    const h2oPartialElement = document.getElementById('h2o-partial-pressure');
    if (h2oPartialElement && h2oPartialElement.textContent) {
        const value = parseFloat(h2oPartialElement.textContent);
        if (!isNaN(value)) {
            h2oPartialElement.textContent = value.toFixed(4) + (currentLanguage === 'ru' ? ' мм рт.ст.' : ' mmHg');
        }
    }
    
    const so3PartialElement = document.getElementById('so3-partial-pressure');
    if (so3PartialElement && so3PartialElement.textContent) {
        const value = parseFloat(so3PartialElement.textContent);
        if (!isNaN(value)) {
            so3PartialElement.textContent = value.toFixed(4) + (currentLanguage === 'ru' ? ' мм рт.ст.' : ' mmHg');
        }
    }
    
    const hclPartialElement = document.getElementById('hcl-partial-pressure');
    if (hclPartialElement && hclPartialElement.textContent) {
        const value = parseFloat(hclPartialElement.textContent);
        if (!isNaN(value)) {
            hclPartialElement.textContent = value.toFixed(4) + (currentLanguage === 'ru' ? ' мм рт.ст.' : ' mmHg');
        }
    }
    
    const h2sPartialElement = document.getElementById('h2s-partial-pressure');
    if (h2sPartialElement && h2sPartialElement.textContent) {
        const value = parseFloat(h2sPartialElement.textContent);
        if (!isNaN(value)) {
            h2sPartialElement.textContent = value.toFixed(4) + (currentLanguage === 'ru' ? ' мм рт.ст.' : ' mmHg');
        }
    }
    
    // Update risk assessment text based on current acid
    if (currentAcid) {
        updateRiskAssessment(currentAcid);
    }
}

// Unit conversion functions
function convertToMMHG(value, unit, pressure) {
    // Convert to mmHg
    if (unit === 'percent') {
        return (value / 100) * pressure * 760; // % to mmHg
    } else if (unit === 'ppm') {
        return (value / 1000000) * pressure * 760; // ppm to mmHg
    } else if (unit === 'mg/nm3') {
        // Convert mg/nm3 to ppm then to mmHg
        let ppm;
        if (currentAcid === 'h2so4' || currentAcid === 'so3') {
            // SO3 molecular weight: 80.06 g/mol
            ppm = (value * 22.4) / 80.06;
        } else if (currentAcid === 'hcl') {
            // HCl molecular weight: 36.46 g/mol
            ppm = (value * 22.4) / 36.46;
        } else if (currentAcid === 'h2s') {
            // H2S molecular weight: 34.08 g/mol
            ppm = (value * 22.4) / 34.08;
        } else {
            // Для воды (H2O) всегда используем молекулярную массу 18.02 g/mol
            ppm = (value * 22.4) / 18.02;
        }
        return (ppm / 1000000) * pressure * 760; // ppm to mmHg
    }
    return value;
}

function convertToVolumeFraction(value, unit, pressure) {
    // Convert to volume fraction (dimensionless)
    if (unit === 'percent') {
        return value / 100; // % to fraction
    } else if (unit === 'ppm') {
        return value / 1000000; // ppm to fraction
    } else if (unit === 'mg/nm3') {
        // Convert mg/nm3 to ppm then to fraction
        let ppm;
        if (currentAcid === 'h2so4' || currentAcid === 'so3') {
            // SO3 molecular weight: 80.06 g/mol
            ppm = (value * 22.4) / 80.06;
        } else if (currentAcid === 'hcl') {
            // HCl molecular weight: 36.46 g/mol
            ppm = (value * 22.4) / 36.46;
        } else if (currentAcid === 'h2s') {
            // H2S molecular weight: 34.08 g/mol
            ppm = (value * 22.4) / 34.08;
        } else {
            // Для воды (H2O) всегда используем молекулярную массу 18.02 g/mol
            ppm = (value * 22.4) / 18.02;
        }
        return ppm / 1000000; // ppm to fraction
    }
    return value;
}

function convertPressure(value, unit) {
    // Convert to atm
    if (unit === 'atm') {
        return value;
    } else if (unit === 'bar') {
        return value * 0.986923; // bar to atm
    } else if (unit === 'kPa') {
        return value * 0.00986923; // kPa to atm
    } else if (unit === 'mmHg') {
        return value / 760; // mmHg to atm
    }
    return value;
}

function celsiusToFahrenheit(celsius) {
    return (celsius * 9/5) + 32;
}

function fahrenheitToCelsius(fahrenheit) {
    return (fahrenheit - 32) * 5/9;
}

// Calculation functions
function calculateH2SO4DewPoint(method, pH2O, pSO3, pressureAtm) {
    let dewPointC = 0;
    
    // Calculate dew point using specified method
    if (method === 'verhoff') {
        // Verhoff method (inputs in mmHg)
        // 1000/T = 2.276 - 0.02943·ln(pH₂O) - 0.0858·ln(pSO₃) + 0.0062·ln(pH₂O)·ln(pSO₃)
        
        // Make sure pH2O and pSO3 are in mmHg
        if (pH2O <= 0) pH2O = 0.001; // Prevent log of zero
        if (pSO3 <= 0) pSO3 = 0.001; // Prevent log of zero
        
        const lnH2O = Math.log(pH2O);
        const lnSO3 = Math.log(pSO3);
        
        const dewPointK = 1000 / (2.276 - 0.02943 * lnH2O - 0.0858 * lnSO3 + 0.0062 * lnH2O * lnSO3);
        dewPointC = dewPointK - 273.15;
    } 
    else if (method === 'okkes') {
        // Okkes method (inputs are volume fractions)
        // T(°C) = 203.25 + 27.6·log₁₀(pH₂O) + 10.83·log₁₀(pSO₃) + 1.06·[log₁₀(pSO₃) + 8]²·¹⁹
        
        // Make sure pH2O and pSO3 are positive
        if (pH2O <= 0) pH2O = 0.000001; // Prevent log of zero
        if (pSO3 <= 0) pSO3 = 0.000001; // Prevent log of zero
        
        dewPointC = 203.25 + 
            27.6 * Math.log10(pH2O) + 
            10.83 * Math.log10(pSO3) + 
            1.06 * Math.pow(Math.log10(pSO3) + 8, 2.19);
    } 
    else if (method === 'zarenezhad') {
        // ZareNezhad method (inputs in mmHg)
        // T(°C) = 150 + 8.1328·ln(pH₂O) + 11.664·ln(pSO₃) - 0.38226·ln(pH₂O)·ln(pSO₃)
        
        // Make sure pH2O and pSO3 are positive
        if (pH2O <= 0) pH2O = 0.001; // Prevent log of zero
        if (pSO3 <= 0) pSO3 = 0.001; // Prevent log of zero
        
        const lnH2O = Math.log(pH2O);
        const lnSO3 = Math.log(pSO3);
        
        dewPointC = 150 + 
            8.1328 * lnH2O + 
            11.664 * lnSO3 - 
            0.38226 * lnH2O * lnSO3;
    }
    
    return Math.max(0, dewPointC); // Ensure not negative
}

function calculateHClDewPoint(pH2O, pHCl, pressureAtm) {
    // Kiang method for HCl dew point (inputs in mmHg)
    // 1000/T = 3.7368 - 0.1591·ln(pH₂O) - 0.0326·ln(pHCl) + 0.00269·ln(pH₂O)·ln(pHCl)
    
    // Make sure pH2O and pHCl are positive
    if (pH2O <= 0) pH2O = 0.001; // Prevent log of zero
    if (pHCl <= 0) pHCl = 0.001; // Prevent log of zero
    
    const lnH2O = Math.log(pH2O);
    const lnHCl = Math.log(pHCl);
    
    const dewPointK = 1000 / (3.7368 - 0.1591 * lnH2O - 0.0326 * lnHCl + 0.00269 * lnH2O * lnHCl);
    const dewPointC = dewPointK - 273.15;
    
    return Math.max(0, dewPointC); // Ensure not negative
}

function calculateH2SDewPoint(pH2S, pressureAtm) {
    // Antoine equation for H2S (NIST data)
    // For temperature range 212.8–349.5 K (from -60.3 °C to +76.4 °C)
    // log₁₀P(bar) = 4.52887 - 958.587/(T(K) - 0.539)
    
    // Convert mmHg to bar
    const pH2SBar = pH2S / 750.06;
    
    if (pH2SBar <= 0) return -100; // Very low pressure, very low dew point
    
    // Solve for T(K)
    // log₁₀(pH2SBar) = 4.52887 - 958.587/(T - 0.539)
    // 958.587/(T - 0.539) = 4.52887 - log₁₀(pH2SBar)
    // T - 0.539 = 958.587/(4.52887 - log₁₀(pH2SBar))
    // T = 958.587/(4.52887 - log₁₀(pH2SBar)) + 0.539
    
    const log10pH2SBar = Math.log10(pH2SBar);
    
    if (log10pH2SBar >= 4.52887) {
        return 76.4; // Maximum temperature in range
    }
    
    const dewPointK = 958.587 / (4.52887 - log10pH2SBar) + 0.539;
    const dewPointC = dewPointK - 273.15;
    
    // Check if result is within valid range
    if (dewPointC < -60.3 || dewPointC > 76.4) {
        // Use the lower range equation for temperatures below -60.3 °C
        // log₁₀P(bar) = 4.43681 - 829.439/(T(K) - 25.412)
        const dewPointK2 = 829.439 / (4.43681 - log10pH2SBar) + 25.412;
        const dewPointC2 = dewPointK2 - 273.15;
        
        return Math.max(-150, dewPointC2); // Practical lower limit
    }
    
    return Math.max(-150, dewPointC); // Practical lower limit
}

function calculateWaterDewPoint(pH2O, pressureAtm) {
    // Simple water dew point calculation
    // Based on Magnus formula: Tdp = b * v / (a - v) where v = a * T / (b + T) + ln(RH/100)
    // Here we directly calculate from partial pressure
    
    // Convert mmHg to relative humidity with respect to 1 atm
    const pH2OAtm = pH2O / 760;
    const relHumidity = pH2OAtm / (0.0000205 * Math.exp(0.0631846 * 25)); // at 25°C reference
    
    const a = 17.27;
    const b = 237.7;
    
    // Approximation valid for 0 < T < 60 °C and 1% < RH < 100%
    const v = Math.log(relHumidity / 100) + (a * 25) / (b + 25);
    const dewPointC = b * v / (a - v);
    
    return Math.max(0, dewPointC); // Ensure not negative
}

// Function to perform all calculations
function performCalculations() {
    // Get input values
    const waterContent = parseFloat(document.getElementById('water-content').value);
    const waterUnit = document.getElementById('water-units').value;
    const systemPressure = parseFloat(document.getElementById('system-pressure').value);
    const pressureUnit = document.getElementById('pressure-units').value;
    
    // Convert pressure to atm
    const pressureAtm = convertPressure(systemPressure, pressureUnit);
    
    // Calculate H2O partial pressure in mmHg
    const pH2OmmHg = convertToMMHG(waterContent, waterUnit, pressureAtm);
    
    // Calculate H2O volume fraction
    const pH2OFraction = convertToVolumeFraction(waterContent, waterUnit, pressureAtm);
    
    // Display intermediate values
    document.getElementById('h2o-partial-pressure').textContent = pH2OmmHg.toFixed(4) + (currentLanguage === 'ru' ? ' мм рт.ст.' : ' mmHg');
    
    // Calculate water dew point
    const waterDewPointC = calculateWaterDewPoint(pH2OmmHg, pressureAtm);
    const waterDewPointF = celsiusToFahrenheit(waterDewPointC);
    
    document.getElementById('water-dew-point').textContent = waterDewPointC.toFixed(1);
    document.getElementById('water-dew-point-f').textContent = `(${waterDewPointF.toFixed(1)} °F)`;
    
    // Variables to store the calculated dew point for reference comparison
    let calculatedDewPoint = 0;
    let acidContentValue = 0;
    let acidContentUnit = '';
    
    if (currentAcid === 'h2so4') {
        // Get SO3 input values
        const so3Content = parseFloat(document.getElementById('so3-content').value);
        const so3Unit = document.getElementById('so3-units').value;
        
        // Store for reference comparison
        acidContentValue = so3Content;
        acidContentUnit = so3Unit;
        
        // Calculate SO3 partial pressure in mmHg
        const pSO3mmHg = convertToMMHG(so3Content, so3Unit, pressureAtm);
        
        // Calculate SO3 volume fraction
        const pSO3Fraction = convertToVolumeFraction(so3Content, so3Unit, pressureAtm);
        
        // Display intermediate SO3 values
        document.getElementById('so3-partial-pressure').textContent = pSO3mmHg.toFixed(4) + (currentLanguage === 'ru' ? ' мм рт.ст.' : ' mmHg');
        
        if (currentMethod === 'all') {
            // Calculate dew points using all methods
            const okkesDewPoint = calculateH2SO4DewPoint('okkes', pH2OFraction, pSO3Fraction, pressureAtm);
            const verhoffDewPoint = calculateH2SO4DewPoint('verhoff', pH2OmmHg, pSO3mmHg, pressureAtm);
            const zareDewPoint = calculateH2SO4DewPoint('zarenezhad', pH2OmmHg, pSO3mmHg, pressureAtm);
            
            // Find maximum dew point
            const maxDewPoint = Math.max(okkesDewPoint, verhoffDewPoint, zareDewPoint);
            const recommendedTemp = maxDewPoint + 10;
            
            // Store for reference comparison
            calculatedDewPoint = maxDewPoint;
            
            // Update comparison table
            document.getElementById('okkes-result').textContent = okkesDewPoint.toFixed(1) + ' °C';
            document.getElementById('verhoff-result').textContent = verhoffDewPoint.toFixed(1) + ' °C';
            document.getElementById('zarenezhad-result').textContent = zareDewPoint.toFixed(1) + ' °C';
            document.getElementById('max-result').textContent = maxDewPoint.toFixed(1) + ' °C';
            document.getElementById('recommended-result').textContent = recommendedTemp.toFixed(1) + ' °C';
            
            // Update Fahrenheit values
            document.getElementById('okkes-result-f').textContent = celsiusToFahrenheit(okkesDewPoint).toFixed(1) + ' °F';
            document.getElementById('verhoff-result-f').textContent = celsiusToFahrenheit(verhoffDewPoint).toFixed(1) + ' °F';
            document.getElementById('zarenezhad-result-f').textContent = celsiusToFahrenheit(zareDewPoint).toFixed(1) + ' °F';
            document.getElementById('max-result-f').textContent = celsiusToFahrenheit(maxDewPoint).toFixed(1) + ' °F';
            document.getElementById('recommended-result-f').textContent = celsiusToFahrenheit(recommendedTemp).toFixed(1) + ' °F';
            
            // Show comparison table, hide single result
            document.getElementById('single-method-results').style.display = 'none';
            document.getElementById('comparison-results').style.display = 'block';
            
            // Update main result
            document.getElementById('h2so4-dew-point').textContent = maxDewPoint.toFixed(1);
            document.getElementById('h2so4-dew-point-f').textContent = `(${celsiusToFahrenheit(maxDewPoint).toFixed(1)} °F)`;
            document.getElementById('recommended-temp').textContent = recommendedTemp.toFixed(1);
            document.getElementById('recommended-temp-f').textContent = `(${celsiusToFahrenheit(recommendedTemp).toFixed(1)} °F)`;
        } else {
            // Calculate dew point using selected method
            let dewPointC = 0;
            
            if (currentMethod === 'okkes') {
                dewPointC = calculateH2SO4DewPoint('okkes', pH2OFraction, pSO3Fraction, pressureAtm);
            } else if (currentMethod === 'verhoff') {
                dewPointC = calculateH2SO4DewPoint('verhoff', pH2OmmHg, pSO3mmHg, pressureAtm);
            } else if (currentMethod === 'zarenezhad') {
                dewPointC = calculateH2SO4DewPoint('zarenezhad', pH2OmmHg, pSO3mmHg, pressureAtm);
            }
            
            // Store for reference comparison
            calculatedDewPoint = dewPointC;
            
            const dewPointF = celsiusToFahrenheit(dewPointC);
            const recommendedTemp = dewPointC + 10;
            const recommendedTempF = celsiusToFahrenheit(recommendedTemp);
            
            // Show single result, hide comparison table
            document.getElementById('single-method-results').style.display = 'flex';
            document.getElementById('comparison-results').style.display = 'none';
            
            // Update results
            document.getElementById('h2so4-dew-point').textContent = dewPointC.toFixed(1);
            document.getElementById('h2so4-dew-point-f').textContent = `(${dewPointF.toFixed(1)} °F)`;
            document.getElementById('recommended-temp').textContent = recommendedTemp.toFixed(1);
            document.getElementById('recommended-temp-f').textContent = `(${recommendedTempF.toFixed(1)} °F)`;
        }
        
        // Update risk assessment
        updateRiskAssessment('h2so4');
    } 
    else if (currentAcid === 'hcl') {
        // Get HCl input values
        const hclContent = parseFloat(document.getElementById('hcl-content').value);
        const hclUnit = document.getElementById('hcl-units').value;
        
        // Store for reference comparison
        acidContentValue = hclContent;
        acidContentUnit = hclUnit;
        
        // Calculate HCl partial pressure in mmHg
        const pHClmmHg = convertToMMHG(hclContent, hclUnit, pressureAtm);
        
        // Display intermediate HCl values
        document.getElementById('hcl-partial-pressure').textContent = pHClmmHg.toFixed(4) + ' мм рт.ст.';
        
        // Calculate HCl dew point
        const hclDewPointC = calculateHClDewPoint(pH2OmmHg, pHClmmHg, pressureAtm);
        
        // Store for reference comparison
        calculatedDewPoint = hclDewPointC;
        
        const hclDewPointF = celsiusToFahrenheit(hclDewPointC);
        const recommendedTemp = hclDewPointC + 10;
        const recommendedTempF = celsiusToFahrenheit(recommendedTemp);
        
        // Show single result, hide comparison table
        document.getElementById('single-method-results').style.display = 'flex';
        document.getElementById('comparison-results').style.display = 'none';
        
        // Update results
        document.getElementById('h2so4-dew-point').textContent = hclDewPointC.toFixed(1);
        document.getElementById('h2so4-dew-point-f').textContent = `(${hclDewPointF.toFixed(1)} °F)`;
        document.getElementById('recommended-temp').textContent = recommendedTemp.toFixed(1);
        document.getElementById('recommended-temp-f').textContent = `(${recommendedTempF.toFixed(1)} °F)`;
        
        // Update risk assessment
        updateRiskAssessment('hcl');
    } 
    else if (currentAcid === 'h2s') {
        // Get H2S input values
        const h2sContent = parseFloat(document.getElementById('h2s-content').value);
        const h2sUnit = document.getElementById('h2s-units').value;
        
        // Store for reference comparison
        acidContentValue = h2sContent;
        acidContentUnit = h2sUnit;
        
        // Calculate H2S partial pressure in mmHg
        const pH2SmmHg = convertToMMHG(h2sContent, h2sUnit, pressureAtm);
        
        // Display intermediate H2S values
        document.getElementById('h2s-partial-pressure').textContent = pH2SmmHg.toFixed(4) + ' мм рт.ст.';
        
        // Calculate H2S dew point
        const h2sDewPointC = calculateH2SDewPoint(pH2SmmHg, pressureAtm);
        
        // Store for reference comparison
        calculatedDewPoint = h2sDewPointC;
        
        const h2sDewPointF = celsiusToFahrenheit(h2sDewPointC);
        
        // For H2S, the recommended temperature is above water dew point
        // since H2S corrosion is mainly an issue when water condenses
        const recommendedTemp = Math.max(h2sDewPointC, waterDewPointC) + 10;
        const recommendedTempF = celsiusToFahrenheit(recommendedTemp);
        
        // Show single result, hide comparison table
        document.getElementById('single-method-results').style.display = 'flex';
        document.getElementById('comparison-results').style.display = 'none';
        
        // Update results
        document.getElementById('h2so4-dew-point').textContent = h2sDewPointC.toFixed(1);
        document.getElementById('h2so4-dew-point-f').textContent = `(${h2sDewPointF.toFixed(1)} °F)`;
        document.getElementById('recommended-temp').textContent = recommendedTemp.toFixed(1);
        document.getElementById('recommended-temp-f').textContent = `(${recommendedTempF.toFixed(1)} °F)`;
        
        // Update risk assessment
        updateRiskAssessment('h2s');
    }
    
    // Update the reference data comparison section
    updateReferenceDataComparison(currentAcid, waterContent, acidContentValue, acidContentUnit, calculatedDewPoint);
    
    // Update graph
    updateGraph();
    
    // Обновляем скорости коррозии
    updateCorrosionRates();
}

// Function to update the reference data comparison section
function updateReferenceDataComparison(acidType, waterPercent, acidContent, acidUnit, calculatedDewPoint) {
    console.log("Updating reference comparison:", {acidType, waterPercent, acidContent, acidUnit, calculatedDewPoint});
    
    let referenceData = null;
    let closestReferenceValue = null;
    let closestConditions = "";
    let deviation = 0;
    let deviationPercent = 0;
    
    // Проверка на NaN и замена на нули
    if (isNaN(waterPercent)) waterPercent = 0;
    if (isNaN(acidContent)) acidContent = 0;
    if (isNaN(calculatedDewPoint)) calculatedDewPoint = 0;
    
    // Convert to standard units for comparison
    let standardizedAcidContent = acidContent;
    if (acidUnit === 'percent') {
        standardizedAcidContent = acidContent * 10000; // Convert % to ppm
    } else if (acidUnit === 'mg/nm3') {
        // Approximate conversion to ppm
        if (acidType === 'h2so4') {
            standardizedAcidContent = acidContent * 0.28; // SO3 mg/nm3 to ppm
        } else if (acidType === 'hcl') {
            standardizedAcidContent = acidContent * 0.61; // HCl mg/nm3 to ppm
        }
    }
    
    console.log("Standardized values:", {waterPercent, standardizedAcidContent});
    
    if (acidType === 'h2so4') {
        // For H2SO4, use the SO3 reference data
        // Find the closest water content
        const waterKeys = [5, 10, 15, 20, 25, 30];
        let closestWaterKey = waterKeys.reduce((prev, curr) => 
            Math.abs(curr - waterPercent) < Math.abs(prev - waterPercent) ? curr : prev
        );
        
        // Find the closest SO3 value in the reference data
        let closestSO3 = null;
        let minDiff = Infinity;
        
        DewPointSourGas.data.forEach(row => {
            const diff = Math.abs(row.so3_ppm - standardizedAcidContent);
            if (diff < minDiff) {
                minDiff = diff;
                closestSO3 = row.so3_ppm;
                closestReferenceValue = row[closestWaterKey.toString()]; // Важно: преобразовать в строку для доступа к свойству
            }
        });
        
        console.log("SO3 reference lookup:", {closestWaterKey, closestSO3, closestReferenceValue});
        
        // Create the conditions text
        closestConditions = `${currentLanguage === 'ru' ? 
            `При SO₃: ${closestSO3} ppm, H₂O: ${closestWaterKey}%` : 
            `At SO₃: ${closestSO3} ppm, H₂O: ${closestWaterKey}%`}`;
        
    } else if (acidType === 'hcl') {
        // For HCl, use the HCl reference data
        // Find the closest water content
        const waterKeys = [5, 10, 15, 20, 25, 30];
        let closestWaterKey = waterKeys.reduce((prev, curr) => 
            Math.abs(curr - waterPercent) < Math.abs(prev - waterPercent) ? curr : prev
        );
        
        // Find the closest HCl value in the reference data
        let closestHCl = null;
        let minDiff = Infinity;
        
        DewPointHCL.data.forEach(row => {
            const diff = Math.abs(row.hcl_ppm - standardizedAcidContent);
            if (diff < minDiff) {
                minDiff = diff;
                closestHCl = row.hcl_ppm;
                closestReferenceValue = row[closestWaterKey.toString()]; // Важно: преобразовать в строку для доступа к свойству
            }
        });
        
        console.log("HCl reference lookup:", {closestWaterKey, closestHCl, closestReferenceValue});
        
        // Create the conditions text
        closestConditions = `${currentLanguage === 'ru' ? 
            `При HCl: ${closestHCl} ppm, H₂O: ${closestWaterKey}%` : 
            `At HCl: ${closestHCl} ppm, H₂O: ${closestWaterKey}%`}`;
        
    } else if (acidType === 'h2s') {
        // For H2S we don't have reference data in the same format
        // We could calculate using a different formula and compare
        // For now, just display N/A
        closestReferenceValue = "N/A";
        closestConditions = `${currentLanguage === 'ru' ? 
            `Недостаточно справочных данных` : 
            `Insufficient reference data`}`;
    }
    
    // Calculate deviation if we have a reference value
    if (closestReferenceValue && closestReferenceValue !== "N/A") {
        // Преобразуем в число в случае, если значение пришло как строка
        closestReferenceValue = parseFloat(closestReferenceValue);
        
        deviation = closestReferenceValue - calculatedDewPoint;
        deviationPercent = calculatedDewPoint !== 0 ? (deviation / calculatedDewPoint) * 100 : 0;
        
        console.log("Deviation calculation:", {calculatedDewPoint, closestReferenceValue, deviation, deviationPercent});
        
        // Update the reference comparison section
        document.getElementById('reference-value').textContent = closestReferenceValue;
        document.getElementById('reference-conditions').textContent = closestConditions;
        document.getElementById('reference-deviation').textContent = deviation.toFixed(1);
        document.getElementById('deviation-percentage').textContent = `(${deviationPercent.toFixed(1)}%)`;
    } else {
        // No reference data available
        document.getElementById('reference-value').textContent = "N/A";
        document.getElementById('reference-conditions').textContent = closestConditions;
        document.getElementById('reference-deviation').textContent = "N/A";
        document.getElementById('deviation-percentage').textContent = "(N/A)";
    }
}

function updateRiskAssessment(acidType) {
    const riskAssessment = document.getElementById('risk-assessment');
    const riskDescription = document.getElementById('risk-description');
    
    if (acidType === 'h2so4') {
        riskAssessment.className = "mt-6 p-4 rounded-lg bg-blue-50";
        
        if (currentLanguage === 'ru') {
            riskDescription.innerHTML = "При работе оборудования на температурах ниже точки росы серной кислоты (H₂SO₄) существует высокий риск коррозии углеродистых и низколегированных сталей. Скорость коррозии максимальна при температурах на 20-40°C ниже точки росы.";
        } else {
            riskDescription.innerHTML = "Operating equipment at temperatures below the sulfuric acid (H₂SO₄) dew point poses a high risk of corrosion for carbon and low-alloy steels. Corrosion rate is highest at temperatures 20-40°C below the dew point.";
        }
    } 
    else if (acidType === 'hcl') {
        riskAssessment.className = "mt-6 p-4 rounded-lg bg-green-50";
        
        if (currentLanguage === 'ru') {
            riskDescription.innerHTML = "Коррозия от соляной кислоты (HCl) представляет опасность для многих материалов, включая нержавеющие стали 300-й серии. HCl-конденсация обычно происходит при температурах около 50-70°C.";
        } else {
            riskDescription.innerHTML = "Hydrochloric acid (HCl) corrosion poses a danger to many materials, including 300-series stainless steels. HCl condensation typically occurs at temperatures around 50-70°C.";
        }
    } 
    else if (acidType === 'h2s') {
        riskAssessment.className = "mt-6 p-4 rounded-lg bg-purple-50";
        
        if (currentLanguage === 'ru') {
            riskDescription.innerHTML = "Для потоков с H₂S критичной обычно является точка росы воды, так как влажный H₂S вызывает сульфидное растрескивание под напряжением (SSC). Чистый H₂S без воды конденсируется только при очень низких температурах.";
        } else {
            riskDescription.innerHTML = "For streams containing H₂S, the water dew point is typically critical, as wet H₂S causes sulfide stress cracking (SSC). Pure H₂S without water condenses only at very low temperatures.";
        }
    }
}

// Function to update the graph
function updateGraph() {
    // Get input values
    const waterContent = parseFloat(document.getElementById('water-content').value);
    const waterUnit = document.getElementById('water-units').value;
    const systemPressure = parseFloat(document.getElementById('system-pressure').value);
    const pressureUnit = document.getElementById('pressure-units').value;
    const pressureAtm = convertPressure(systemPressure, pressureUnit);
    
    let acidContent = 0;
    let acidUnit = '';
    
    if (currentAcid === 'h2so4') {
        acidContent = parseFloat(document.getElementById('so3-content').value);
        acidUnit = document.getElementById('so3-units').value;
    } else if (currentAcid === 'hcl') {
        acidContent = parseFloat(document.getElementById('hcl-content').value);
        acidUnit = document.getElementById('hcl-units').value;
    } else if (currentAcid === 'h2s') {
        acidContent = parseFloat(document.getElementById('h2s-content').value);
        acidUnit = document.getElementById('h2s-units').value;
    }
    
    // Prepare data for graphs
    let xValues = [];
    let yValuesMethod1 = [];
    let yValuesMethod2 = [];
    let yValuesMethod3 = [];
    let yValuesWater = [];
    
    let graphTitle = '';
    let xAxisLabel = '';
    let yAxisLabel = '';
    
    // Determine what to plot based on graph type
    if (currentGraphType === 'h2o') {
        // Vary water content, keep acid content constant
        if (currentLanguage === 'ru') {
            graphTitle = 'Зависимость точки росы от содержания H₂O';
            xAxisLabel = 'Содержание H₂O (% об.)';
            yAxisLabel = 'Точка росы (°C)';
            document.getElementById('graph-description').innerHTML = 'График показывает зависимость точки росы от содержания воды (H₂O) при фиксированных значениях других параметров.';
        } else {
            graphTitle = 'Dew Point vs H₂O Content';
            xAxisLabel = 'H₂O Content (% vol.)';
            yAxisLabel = 'Dew Point (°C)';
            document.getElementById('graph-description').innerHTML = 'The graph shows the dependence of dew point on water content (H₂O) while other parameters remain fixed.';
        }
        
        for (let h2oPercent = 1; h2oPercent <= 30; h2oPercent += 1) {
            xValues.push(h2oPercent);
            
            const pH2OmmHg = convertToMMHG(h2oPercent, 'percent', pressureAtm);
            const pH2OFraction = convertToVolumeFraction(h2oPercent, 'percent', pressureAtm);
            
            // Calculate water dew point
            const waterDewPointC = calculateWaterDewPoint(pH2OmmHg, pressureAtm);
            yValuesWater.push(waterDewPointC);
            
            if (currentAcid === 'h2so4') {
                const pSO3mmHg = convertToMMHG(acidContent, acidUnit, pressureAtm);
                const pSO3Fraction = convertToVolumeFraction(acidContent, acidUnit, pressureAtm);
                
                // Calculate using different methods
                const okkesDewPoint = calculateH2SO4DewPoint('okkes', pH2OFraction, pSO3Fraction, pressureAtm);
                const verhoffDewPoint = calculateH2SO4DewPoint('verhoff', pH2OmmHg, pSO3mmHg, pressureAtm);
                const zareDewPoint = calculateH2SO4DewPoint('zarenezhad', pH2OmmHg, pSO3mmHg, pressureAtm);
                
                yValuesMethod1.push(okkesDewPoint);
                yValuesMethod2.push(verhoffDewPoint);
                yValuesMethod3.push(zareDewPoint);
            } 
            else if (currentAcid === 'hcl') {
                const pHClmmHg = convertToMMHG(acidContent, acidUnit, pressureAtm);
                const hclDewPoint = calculateHClDewPoint(pH2OmmHg, pHClmmHg, pressureAtm);
                yValuesMethod1.push(hclDewPoint);
            } 
            else if (currentAcid === 'h2s') {
                const pH2SmmHg = convertToMMHG(acidContent, acidUnit, pressureAtm);
                const h2sDewPoint = calculateH2SDewPoint(pH2SmmHg, pressureAtm);
                yValuesMethod1.push(h2sDewPoint);
            }
        }
    } 
    else if (currentGraphType === 'acid') {
        // Vary acid content, keep water content constant
        if (currentAcid === 'h2so4') {
            if (currentLanguage === 'ru') {
                graphTitle = 'Зависимость точки росы от содержания SO₃';
                xAxisLabel = 'Содержание SO₃ (ppm)';
                yAxisLabel = 'Точка росы (°C)';
                document.getElementById('graph-description').innerHTML = 'График показывает зависимость точки росы от содержания SO₃ при фиксированном содержании воды (H₂O).';
            } else {
                graphTitle = 'Dew Point vs SO₃ Content';
                xAxisLabel = 'SO₃ Content (ppm)';
                yAxisLabel = 'Dew Point (°C)';
                document.getElementById('graph-description').innerHTML = 'The graph shows the dependence of dew point on SO₃ content at fixed water content (H₂O).';
            }
            
            for (let so3ppm = 1; so3ppm <= 100; so3ppm += 5) {
                xValues.push(so3ppm);
                
                const pH2OmmHg = convertToMMHG(waterContent, waterUnit, pressureAtm);
                const pH2OFraction = convertToVolumeFraction(waterContent, waterUnit, pressureAtm);
                
                const pSO3mmHg = convertToMMHG(so3ppm, 'ppm', pressureAtm);
                const pSO3Fraction = convertToVolumeFraction(so3ppm, 'ppm', pressureAtm);
                
                // Calculate using different methods
                const okkesDewPoint = calculateH2SO4DewPoint('okkes', pH2OFraction, pSO3Fraction, pressureAtm);
                const verhoffDewPoint = calculateH2SO4DewPoint('verhoff', pH2OmmHg, pSO3mmHg, pressureAtm);
                const zareDewPoint = calculateH2SO4DewPoint('zarenezhad', pH2OmmHg, pSO3mmHg, pressureAtm);
                
                yValuesMethod1.push(okkesDewPoint);
                yValuesMethod2.push(verhoffDewPoint);
                yValuesMethod3.push(zareDewPoint);
                
                // Water dew point is constant
                const waterDewPointC = calculateWaterDewPoint(pH2OmmHg, pressureAtm);
                yValuesWater.push(waterDewPointC);
            }
        } 
        else if (currentAcid === 'hcl') {
            if (currentLanguage === 'ru') {
                graphTitle = 'Зависимость точки росы от содержания HCl';
                xAxisLabel = 'Содержание HCl (ppm)';
                yAxisLabel = 'Точка росы (°C)';
                document.getElementById('graph-description').innerHTML = 'График показывает зависимость точки росы от содержания HCl при фиксированном содержании воды (H₂O).';
            } else {
                graphTitle = 'Dew Point vs HCl Content';
                xAxisLabel = 'HCl Content (ppm)';
                yAxisLabel = 'Dew Point (°C)';
                document.getElementById('graph-description').innerHTML = 'The graph shows the dependence of dew point on HCl content at fixed water content (H₂O).';
            }
            
            for (let hclppm = 10; hclppm <= 1000; hclppm += 50) {
                xValues.push(hclppm);
                
                const pH2OmmHg = convertToMMHG(waterContent, waterUnit, pressureAtm);
                const pHClmmHg = convertToMMHG(hclppm, 'ppm', pressureAtm);
                
                const hclDewPoint = calculateHClDewPoint(pH2OmmHg, pHClmmHg, pressureAtm);
                yValuesMethod1.push(hclDewPoint);
                
                // Water dew point is constant
                const waterDewPointC = calculateWaterDewPoint(pH2OmmHg, pressureAtm);
                yValuesWater.push(waterDewPointC);
            }
        } 
        else if (currentAcid === 'h2s') {
            if (currentLanguage === 'ru') {
                graphTitle = 'Зависимость точки росы от содержания H₂S';
                xAxisLabel = 'Содержание H₂S (% об.)';
                yAxisLabel = 'Точка росы (°C)';
                document.getElementById('graph-description').innerHTML = 'График показывает зависимость точки росы от содержания H₂S при фиксированном содержании воды (H₂O).';
            } else {
                graphTitle = 'Dew Point vs H₂S Content';
                xAxisLabel = 'H₂S Content (% vol.)';
                yAxisLabel = 'Dew Point (°C)';
                document.getElementById('graph-description').innerHTML = 'The graph shows the dependence of dew point on H₂S content at fixed water content (H₂O).';
            }
            
            for (let h2sPercent = 0.1; h2sPercent <= 10; h2sPercent += 0.5) {
                xValues.push(h2sPercent);
                
                const pH2OmmHg = convertToMMHG(waterContent, waterUnit, pressureAtm);
                const pH2SmmHg = convertToMMHG(h2sPercent, 'percent', pressureAtm);
                
                const h2sDewPoint = calculateH2SDewPoint(pH2SmmHg, pressureAtm);
                yValuesMethod1.push(h2sDewPoint);
                
                // Water dew point is constant
                const waterDewPointC = calculateWaterDewPoint(pH2OmmHg, pressureAtm);
                yValuesWater.push(waterDewPointC);
            }
        }
    } 
    else if (currentGraphType === 'pressure') {
        // Vary pressure, keep other parameters constant
        if (currentLanguage === 'ru') {
            graphTitle = 'Зависимость точки росы от давления';
            xAxisLabel = 'Давление (атм)';
            yAxisLabel = 'Точка росы (°C)';
            document.getElementById('graph-description').innerHTML = 'График показывает зависимость точки росы от давления системы при фиксированных содержаниях H₂O и кислотных компонентов.';
        } else {
            graphTitle = 'Dew Point vs Pressure';
            xAxisLabel = 'Pressure (atm)';
            yAxisLabel = 'Dew Point (°C)';
            document.getElementById('graph-description').innerHTML = 'The graph shows the dependence of dew point on system pressure at fixed H₂O and acid component contents.';
        }
        
        for (let pressure = 0.5; pressure <= 5; pressure += 0.25) {
            xValues.push(pressure);
            
            const pH2OmmHg = convertToMMHG(waterContent, waterUnit, pressure);
            const pH2OFraction = convertToVolumeFraction(waterContent, waterUnit, pressure);
            
            // Calculate water dew point
            const waterDewPointC = calculateWaterDewPoint(pH2OmmHg, pressure);
            yValuesWater.push(waterDewPointC);
            
            if (currentAcid === 'h2so4') {
                const pSO3mmHg = convertToMMHG(acidContent, acidUnit, pressure);
                const pSO3Fraction = convertToVolumeFraction(acidContent, acidUnit, pressure);
                
                // Calculate using different methods
                const okkesDewPoint = calculateH2SO4DewPoint('okkes', pH2OFraction, pSO3Fraction, pressure);
                const verhoffDewPoint = calculateH2SO4DewPoint('verhoff', pH2OmmHg, pSO3mmHg, pressure);
                const zareDewPoint = calculateH2SO4DewPoint('zarenezhad', pH2OmmHg, pSO3mmHg, pressure);
                
                yValuesMethod1.push(okkesDewPoint);
                yValuesMethod2.push(verhoffDewPoint);
                yValuesMethod3.push(zareDewPoint);
            } 
            else if (currentAcid === 'hcl') {
                const pHClmmHg = convertToMMHG(acidContent, acidUnit, pressure);
                const hclDewPoint = calculateHClDewPoint(pH2OmmHg, pHClmmHg, pressure);
                yValuesMethod1.push(hclDewPoint);
            } 
            else if (currentAcid === 'h2s') {
                const pH2SmmHg = convertToMMHG(acidContent, acidUnit, pressure);
                const h2sDewPoint = calculateH2SDewPoint(pH2SmmHg, pressure);
                yValuesMethod1.push(h2sDewPoint);
            }
        }
    } 
    else if (currentGraphType === 'compare' && currentAcid === 'h2so4') {
        // Compare different methods for H2SO4
        if (currentLanguage === 'ru') {
            graphTitle = 'Сравнение методов расчета точки росы H₂SO₄';
            xAxisLabel = 'Содержание SO₃ (ppm)';
            yAxisLabel = 'Точка росы (°C)';
            document.getElementById('graph-description').innerHTML = 'График сравнивает различные методы расчета точки росы H₂SO₄ в зависимости от содержания SO₃ при фиксированном содержании воды.';
        } else {
            graphTitle = 'Comparison of H₂SO₄ Dew Point Methods';
            xAxisLabel = 'SO₃ Content (ppm)';
            yAxisLabel = 'Dew Point (°C)';
            document.getElementById('graph-description').innerHTML = 'The graph compares different methods for calculating H₂SO₄ dew point as a function of SO₃ content at fixed water content.';
        }
        
        for (let so3ppm = 1; so3ppm <= 100; so3ppm += 5) {
            xValues.push(so3ppm);
            
            const pH2OmmHg = convertToMMHG(waterContent, waterUnit, pressureAtm);
            const pH2OFraction = convertToVolumeFraction(waterContent, waterUnit, pressureAtm);
            
            const pSO3mmHg = convertToMMHG(so3ppm, 'ppm', pressureAtm);
            const pSO3Fraction = convertToVolumeFraction(so3ppm, 'ppm', pressureAtm);
            
            // Calculate using different methods
            const okkesDewPoint = calculateH2SO4DewPoint('okkes', pH2OFraction, pSO3Fraction, pressureAtm);
            const verhoffDewPoint = calculateH2SO4DewPoint('verhoff', pH2OmmHg, pSO3mmHg, pressureAtm);
            const zareDewPoint = calculateH2SO4DewPoint('zarenezhad', pH2OmmHg, pSO3mmHg, pressureAtm);
            
            yValuesMethod1.push(okkesDewPoint);
            yValuesMethod2.push(verhoffDewPoint);
            yValuesMethod3.push(zareDewPoint);
            
            // Water dew point
            const waterDewPointC = calculateWaterDewPoint(pH2OmmHg, pressureAtm);
            yValuesWater.push(waterDewPointC);
        }
    }
    
    // Create or update chart
    if (dewPointChart) {
        dewPointChart.destroy();
    }
    
    const ctx = document.getElementById('dewPointChart').getContext('2d');
    
    const datasets = [];
    
    if (currentAcid === 'h2so4') {
        if (currentGraphType === 'compare' || currentMethod === 'all') {
            // Add datasets for all methods
            datasets.push({
                label: 'Okkes (1987)',
                data: yValuesMethod1,
                borderColor: 'rgba(54, 162, 235, 1)',
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderWidth: 2,
                fill: false
            });
            
            datasets.push({
                label: 'Verhoff (1974)',
                data: yValuesMethod2,
                borderColor: 'rgba(255, 99, 132, 1)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                borderWidth: 2,
                fill: false
            });
            
            datasets.push({
                label: 'ZareNezhad (2009)',
                data: yValuesMethod3,
                borderColor: 'rgba(75, 192, 192, 1)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderWidth: 2,
                fill: false
            });
        } else {
            // Add dataset for selected method
            let methodLabel = '';
            let methodData = [];
            
            if (currentMethod === 'okkes') {
                methodLabel = 'Okkes (1987)';
                methodData = yValuesMethod1;
            } else if (currentMethod === 'verhoff') {
                methodLabel = 'Verhoff (1974)';
                methodData = yValuesMethod2;
            } else if (currentMethod === 'zarenezhad') {
                methodLabel = 'ZareNezhad (2009)';
                methodData = yValuesMethod3;
            }
            
            datasets.push({
                label: `H₂SO₄ (${methodLabel})`,
                data: methodData,
                borderColor: 'rgba(54, 162, 235, 1)',
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderWidth: 2,
                fill: false
            });
        }
    } 
    else if (currentAcid === 'hcl') {
        datasets.push({
            label: 'HCl (Kiang 1981)',
            data: yValuesMethod1,
            borderColor: 'rgba(255, 99, 132, 1)',
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            borderWidth: 2,
            fill: false
        });
    } 
    else if (currentAcid === 'h2s') {
        datasets.push({
            label: 'H₂S (Antoine)',
            data: yValuesMethod1,
            borderColor: 'rgba(153, 102, 255, 1)',
            backgroundColor: 'rgba(153, 102, 255, 0.2)',
            borderWidth: 2,
            fill: false
        });
    }
    
    // Add water dew point
    datasets.push({
        label: 'H₂O (Вода)',
        data: yValuesWater,
        borderColor: 'rgba(75, 192, 192, 1)',
        backgroundColor: 'rgba(75, 192, 192, 0.2)',
        borderWidth: 2,
        fill: false,
        borderDash: [5, 5]
    });
    
    dewPointChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: xValues,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            title: {
                display: true,
                text: graphTitle,
                fontSize: 16
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: xAxisLabel
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: yAxisLabel
                    }
                }
            },
            plugins: {
                tooltip: {
                    mode: 'index',
                    intersect: false
                },
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// Function to populate reference tables
function populateReferenceTables() {
    // Populate H2SO4 table
    const h2so4TableBody = document.getElementById('h2so4-table-body');
    h2so4TableBody.innerHTML = ''; // Clear existing content
    
    // Add rows from DewPointSourGas data
    DewPointSourGas.data.forEach(row => {
        if (row.so3_ppm <= 100) { // Limit to reasonable values for display
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="border px-4 py-2 font-medium">${row.so3_ppm}</td>
                <td class="border px-4 py-2">${row['5']}</td>
                <td class="border px-4 py-2">${row['10']}</td>
                <td class="border px-4 py-2">${row['15']}</td>
                <td class="border px-4 py-2">${row['20']}</td>
                <td class="border px-4 py-2">${row['25']}</td>
                <td class="border px-4 py-2">${row['30']}</td>
            `;
            h2so4TableBody.appendChild(tr);
        }
    });
    
    // Populate HCl table
    const hclTableBody = document.getElementById('hcl-table-body');
    hclTableBody.innerHTML = ''; // Clear existing content
    
    // Add rows from DewPointHCL data
    DewPointHCL.data.forEach(row => {
        if (row.hcl_ppm <= 1000) { // Limit to reasonable values for display
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="border px-4 py-2 font-medium">${row.hcl_ppm}</td>
                <td class="border px-4 py-2">${row['5']}</td>
                <td class="border px-4 py-2">${row['10']}</td>
                <td class="border px-4 py-2">${row['15']}</td>
                <td class="border px-4 py-2">${row['20']}</td>
                <td class="border px-4 py-2">${row['25']}</td>
                <td class="border px-4 py-2">${row['30']}</td>
            `;
            hclTableBody.appendChild(tr);
        }
    });
    
    // Populate Corrosion Rate tables
    const corrosionTable40c = document.getElementById('corrosion-table-body-40c');
    const corrosionTable80c = document.getElementById('corrosion-table-body-80c');
    
    corrosionTable40c.innerHTML = ''; // Clear existing content
    corrosionTable80c.innerHTML = ''; // Clear existing content
    
    // Loop through each steel type
    CorrosionHCL.data.forEach(steelData => {
        // Add row for 40°C
        const dataFor40c = steelData.datasets.find(d => d.temperature === 40);
        if (dataFor40c) {
            const tr40c = document.createElement('tr');
            tr40c.innerHTML = `
                <td class="border px-3 py-1 font-medium">${steelData.steelType}</td>
                <td class="border px-3 py-1">${dataFor40c.points.find(p => p.concentration === 3)?.corrosionRate.toFixed(2)}</td>
                <td class="border px-3 py-1">${dataFor40c.points.find(p => p.concentration === 10)?.corrosionRate.toFixed(2)}</td>
                <td class="border px-3 py-1">${dataFor40c.points.find(p => p.concentration === 20)?.corrosionRate.toFixed(2)}</td>
            `;
            corrosionTable40c.appendChild(tr40c);
        }
        
        // Add row for 80°C
        const dataFor80c = steelData.datasets.find(d => d.temperature === 80);
        if (dataFor80c) {
            const tr80c = document.createElement('tr');
            tr80c.innerHTML = `
                <td class="border px-3 py-1 font-medium">${steelData.steelType}</td>
                <td class="border px-3 py-1">${dataFor80c.points.find(p => p.concentration === 3)?.corrosionRate.toFixed(2)}</td>
                <td class="border px-3 py-1">${dataFor80c.points.find(p => p.concentration === 10)?.corrosionRate.toFixed(2)}</td>
                <td class="border px-3 py-1">${dataFor80c.points.find(p => p.concentration === 20)?.corrosionRate.toFixed(2)}</td>
            `;
            corrosionTable80c.appendChild(tr80c);
        }
    });
}

// Function to update corrosion rates based on calculated values
function updateCorrosionRates() {
    // Получаем текущие значения параметров
    const acidType = currentAcid;
    
    // Текущие значения кислотного содержания
    let acidContent = 0;
    if (acidType === 'h2so4') {
        acidContent = parseFloat(document.getElementById('so3-content').value);
    } else if (acidType === 'hcl') {
        acidContent = parseFloat(document.getElementById('hcl-content').value);
    } else if (acidType === 'h2s') {
        acidContent = parseFloat(document.getElementById('h2s-content').value);
    }
    
    // Текущая температура (считаем, что температура равна точке росы, худший случай)
    const dewPointC = parseFloat(document.getElementById('h2so4-dew-point').textContent);
    
    // Пересчёт в проценты если используются ppm
    let acidPercent = acidContent;
    if (acidType === 'h2so4' || acidType === 'hcl') {
        const acidUnit = document.getElementById(acidType === 'h2so4' ? 'so3-units' : 'hcl-units').value;
        if (acidUnit === 'ppm') {
            acidPercent = acidContent / 10000;
        }
    }
    
    // Вместо выбора ближайшей концентрации и температуры, будем использовать интерполяцию
    // Определяем граничные значения для интерполяции
    const concentrations = [3, 10, 20]; // Доступные концентрации
    const temperatures = [40, 80]; // Доступные температуры
    
    // Ограничиваем значения в диапазоне имеющихся данных
    acidPercent = Math.min(Math.max(acidPercent, concentrations[0]), concentrations[concentrations.length - 1]);
    const tempValue = Math.min(Math.max(dewPointC, temperatures[0]), temperatures[temperatures.length - 1]);
    
    // Обновляем значения скорости коррозии для всех материалов
    const materials = ['carbon-steel', 'ss304', 'ss316l'];
    const materialNames = ['Mild Steel', 'SUS 304', 'SUS 316L'];
    
    materials.forEach((material, index) => {
        // Находим данные для этого материала
        const steelData = CorrosionHCL.data.find(d => d.steelType === materialNames[index]);
        if (!steelData) return;
        
        // Интерполяция по концентрации и температуре
        let finalCorrosionRate = 0;
        
        // Определяем ближайшие индексы для концентрации
        let lowerConcIdx = 0;
        let upperConcIdx = 1;
        for (let i = 0; i < concentrations.length - 1; i++) {
            if (acidPercent >= concentrations[i] && acidPercent <= concentrations[i + 1]) {
                lowerConcIdx = i;
                upperConcIdx = i + 1;
                break;
            }
        }
        
        // Получаем значения для интерполяции по температуре для обеих концентраций
        const lowerConcRates = [];
        const upperConcRates = [];
        
        for (let t = 0; t < temperatures.length; t++) {
            const datasetForTemp = steelData.datasets.find(d => d.temperature === temperatures[t]);
            if (datasetForTemp) {
                const lowerConcPoint = datasetForTemp.points.find(p => p.concentration === concentrations[lowerConcIdx]);
                const upperConcPoint = datasetForTemp.points.find(p => p.concentration === concentrations[upperConcIdx]);
                
                if (lowerConcPoint && upperConcPoint) {
                    lowerConcRates.push(lowerConcPoint.corrosionRate);
                    upperConcRates.push(upperConcPoint.corrosionRate);
                }
            }
        }
        
        // Если у нас есть все необходимые данные, выполняем двумерную интерполяцию
        if (lowerConcRates.length === 2 && upperConcRates.length === 2) {
            // Интерполяция по концентрации для нижней температуры
            const concWeight = (acidPercent - concentrations[lowerConcIdx]) / 
                             (concentrations[upperConcIdx] - concentrations[lowerConcIdx]);
            
            const lowerTempRate = lowerConcRates[0] + concWeight * (upperConcRates[0] - lowerConcRates[0]);
            const upperTempRate = lowerConcRates[1] + concWeight * (upperConcRates[1] - lowerConcRates[1]);
            
            // Интерполяция по температуре
            const tempWeight = (tempValue - temperatures[0]) / (temperatures[1] - temperatures[0]);
            finalCorrosionRate = lowerTempRate + tempWeight * (upperTempRate - lowerTempRate);
        }
        
        // Если интерполяция не сработала, используем старый метод
        if (finalCorrosionRate === 0) {
            // Определяем ближайшую концентрацию
            let closestConcentration = 3; // По умолчанию
            if (acidPercent <= 5) closestConcentration = 3;
            else if (acidPercent <= 15) closestConcentration = 10;
            else closestConcentration = 20;
            
            // Определяем ближайшую температуру
            const temperature = dewPointC <= 60 ? 40 : 80;
            
            const tempData = steelData.datasets.find(d => d.temperature === temperature);
            if (tempData) {
                const dataPoint = tempData.points.find(p => p.concentration === closestConcentration);
                if (dataPoint) {
                    finalCorrosionRate = dataPoint.corrosionRate;
                }
            }
        }
        
        // Обновляем отображение
        document.getElementById(`${material}-rate`).textContent = finalCorrosionRate.toFixed(1);
        
        // Обновляем описание скорости коррозии
        const rateDesc = document.getElementById(`${material}-rate`).nextElementSibling.nextElementSibling;
        if (rateDesc) {
            if (currentLanguage === 'ru') {
                if (finalCorrosionRate < 0.1) rateDesc.innerHTML = '<span class="lang-ru">Очень низкая скорость</span>';
                else if (finalCorrosionRate < 1.0) rateDesc.innerHTML = '<span class="lang-ru">Низкая скорость</span>';
                else if (finalCorrosionRate < 5.0) rateDesc.innerHTML = '<span class="lang-ru">Средняя скорость</span>';
                else if (finalCorrosionRate < 20.0) rateDesc.innerHTML = '<span class="lang-ru">Высокая скорость</span>';
                else rateDesc.innerHTML = '<span class="lang-ru">Очень высокая скорость</span>';
            } else {
                if (finalCorrosionRate < 0.1) rateDesc.innerHTML = '<span class="lang-en">Very low rate</span>';
                else if (finalCorrosionRate < 1.0) rateDesc.innerHTML = '<span class="lang-en">Low rate</span>';
                else if (finalCorrosionRate < 5.0) rateDesc.innerHTML = '<span class="lang-en">Moderate rate</span>';
                else if (finalCorrosionRate < 20.0) rateDesc.innerHTML = '<span class="lang-en">High rate</span>';
                else rateDesc.innerHTML = '<span class="lang-en">Very high rate</span>';
            }
        }
    });
}

// Function to create heatmap charts
function createHeatmapCharts() {
    // Create charts for both H2SO4 and HCl, plus corrosion rate chart
    createH2SO4Heatmap();
    createHClHeatmap();
    createCorrosionRateChart();
}

// Event listeners for tab navigation
document.addEventListener('DOMContentLoaded', function() {
    // Add event listeners for tabs
    document.querySelectorAll('.tab-btn').forEach(button => {
        button.addEventListener('click', function() {
            const tabId = this.getAttribute('data-tab');
            
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
                tab.classList.remove('fade-in');
            });
            
            // Show selected tab
            document.getElementById(tabId).style.display = 'block';
            setTimeout(() => {
                document.getElementById(tabId).classList.add('fade-in');
            }, 10);
            
            // Set active tab button
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('tab-active');
            });
            
            this.classList.add('tab-active');
            
            // If reference data tab is shown, create heatmap charts
            if (tabId === 'reference-data') {
                setTimeout(createHeatmapCharts, 100);
            }
        });
    });
    
    // Add event listeners for acid type buttons
    document.querySelectorAll('.acid-type-btn').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('.acid-type-btn').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            
            this.classList.remove('bg-gray-200', 'text-gray-700');
            this.classList.add('btn-primary');
            
            currentAcid = this.getAttribute('data-acid');
            
            // Show/hide content containers
            document.getElementById('so3-content-container').style.display = currentAcid === 'h2so4' ? 'block' : 'none';
            document.getElementById('hcl-content-container').style.display = currentAcid === 'hcl' ? 'block' : 'none';
            document.getElementById('h2s-content-container').style.display = currentAcid === 'h2s' ? 'block' : 'none';
            
            document.getElementById('so3-partial-section').style.display = currentAcid === 'h2so4' ? 'block' : 'none';
            document.getElementById('hcl-partial-section').style.display = currentAcid === 'hcl' ? 'block' : 'none';
            document.getElementById('h2s-partial-section').style.display = currentAcid === 'h2s' ? 'block' : 'none';
            
            document.getElementById('method-selection-h2so4').style.display = currentAcid === 'h2so4' ? 'block' : 'none';
            document.getElementById('method-selection-hcl').style.display = currentAcid === 'hcl' ? 'block' : 'none';
            document.getElementById('method-selection-h2s').style.display = currentAcid === 'h2s' ? 'block' : 'none';
            
            // Update dew point title
            if (currentAcid === 'h2so4') {
                document.getElementById('acid-dew-point-title-ru').textContent = 'Точка росы H₂SO₄';
                document.getElementById('acid-dew-point-title-en').textContent = 'H₂SO₄ Dew Point';
                currentMethod = document.getElementById('calculation-method-h2so4').value;
            } else if (currentAcid === 'hcl') {
                document.getElementById('acid-dew-point-title-ru').textContent = 'Точка росы HCl';
                document.getElementById('acid-dew-point-title-en').textContent = 'HCl Dew Point';
                currentMethod = document.getElementById('calculation-method-hcl').value;
            } else if (currentAcid === 'h2s') {
                document.getElementById('acid-dew-point-title-ru').textContent = 'Точка росы H₂S';
                document.getElementById('acid-dew-point-title-en').textContent = 'H₂S Dew Point';
                currentMethod = document.getElementById('calculation-method-h2s').value;
            }
            
            // Perform calculations
            performCalculations();
        });
    });
    
    // Add event listeners for method selection
    document.getElementById('calculation-method-h2so4').addEventListener('change', function() {
        currentMethod = this.value;
        
        // Show/hide comparison results
        if (currentMethod === 'all') {
            document.getElementById('comparison-results').style.display = 'block';
            document.getElementById('single-method-results').style.display = 'none';
        } else {
            document.getElementById('comparison-results').style.display = 'none';
            document.getElementById('single-method-results').style.display = 'flex';
        }
        
        performCalculations();
    });
    
    document.getElementById('calculation-method-hcl').addEventListener('change', function() {
        currentMethod = this.value;
        performCalculations();
    });
    
    document.getElementById('calculation-method-h2s').addEventListener('change', function() {
        currentMethod = this.value;
        performCalculations();
    });
    
    // Add event listeners for graph type buttons
    document.querySelectorAll('.graph-type-btn').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('.graph-type-btn').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            
            this.classList.remove('bg-gray-200', 'text-gray-700');
            this.classList.add('btn-primary');
            
            currentGraphType = this.id.replace('graph-type-', '');
            updateGraph();
        });
    });
    
    // Add event listeners for reference data buttons
    document.querySelectorAll('.ref-data-btn').forEach(button => {
        button.addEventListener('click', function() {
            // Update active button styles
            document.querySelectorAll('.ref-data-btn').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            
            this.classList.remove('bg-gray-200', 'text-gray-700');
            this.classList.add('btn-primary');
            
            // Hide all data panels
            document.getElementById('ref-h2so4-data').classList.add('hidden');
            document.getElementById('ref-hcl-data').classList.add('hidden');
            document.getElementById('ref-corrosion-data').classList.add('hidden');
            
            // Show selected panel
            const buttonId = this.id;
            if (buttonId === 'ref-h2so4-btn') {
                document.getElementById('ref-h2so4-data').classList.remove('hidden');
                setTimeout(() => createH2SO4Heatmap(), 100);
            } else if (buttonId === 'ref-hcl-btn') {
                document.getElementById('ref-hcl-data').classList.remove('hidden');
                setTimeout(() => createHClHeatmap(), 100);
            } else if (buttonId === 'ref-corrosion-btn') {
                document.getElementById('ref-corrosion-data').classList.remove('hidden');
                setTimeout(() => createCorrosionRateChart(), 100);
            }
        });
    });
    
    // Initialize with Russian language
    setLanguage('ru');
    
    // Initialize default acid type and calculations
    currentAcid = 'h2so4';
    currentMethod = 'okkes';
    currentGraphType = 'h2o';
    
    // Populate reference tables
    populateReferenceTables();
    
    // Perform initial calculations
    setTimeout(performCalculations, 100);
});







        // Function to toggle language between Russian and English
        function toggleLanguage() {
            console.log('Toggling language. Current language:', currentLanguage);
            
            // Set language toggle
            if (currentLanguage === 'ru') {
                // Switch to English
                document.querySelectorAll('.lang-ru').forEach(el => {
                    el.style.display = 'none';
                });
                
                document.querySelectorAll('.lang-en').forEach(el => {
                    el.style.display = 'inline-block';
                });
                
                document.documentElement.lang = 'en';
                currentLanguage = 'en';
            } else {
                // Switch to Russian
                document.querySelectorAll('.lang-en').forEach(el => {
                    el.style.display = 'none';
                });
                
                document.querySelectorAll('.lang-ru').forEach(el => {
                    el.style.display = 'inline-block';
                });
                
                document.documentElement.lang = 'ru';
                currentLanguage = 'ru';
            }
            
            // Update graphs if they exist
            if (dewPointChart) {
                updateGraph();
            }
            
            // Update reference data charts if visible
            if (document.getElementById('reference-data').style.display === 'block') {
                setTimeout(createHeatmapCharts, 100);
            }
            
            console.log('Language switched to:', currentLanguage);
        }

        const DewPointHCL = {
            "title": "Таблица точек росы соляной кислоты для газа типа HCℓ-H₂O",
            "xAxis": "Влажность в газе (об.%)",
            "yAxis": "Хлороводород в газе (объемный ppm)",
            "units": "°C",
            "data": [
                {
                "hcl_ppm": 1,
                "5": 33,
                "10": 46,
                "15": 53,
                "20": 60,
                "25": 66,
                "30": 69,
                "35": 74,
                "40": 76,
                "45": 79,
                "50": 81,
                "55": 84,
                "60": 87
                },
                {
                "hcl_ppm": 10,
                "5": 33,
                "10": 46,
                "15": 53,
                "20": 60,
                "25": 66,
                "30": 69,
                "35": 74,
                "40": 76,
                "45": 79,
                "50": 81,
                "55": 84,
                "60": 87
                },
                {
                "hcl_ppm": 20,
                "5": 34,
                "10": 46,
                "15": 53,
                "20": 60,
                "25": 66,
                "30": 69,
                "35": 74,
                "40": 76,
                "45": 79,
                "50": 81,
                "55": 84,
                "60": 87
                },
                {
                "hcl_ppm": 30,
                "5": 35,
                "10": 47,
                "15": 54,
                "20": 60,
                "25": 66,
                "30": 69,
                "35": 74,
                "40": 76,
                "45": 79,
                "50": 81,
                "55": 84,
                "60": 87
                },
                {
                "hcl_ppm": 40,
                "5": 36,
                "10": 47,
                "15": 55,
                "20": 60,
                "25": 66,
                "30": 69,
                "35": 74,
                "40": 76,
                "45": 79,
                "50": 81,
                "55": 84,
                "60": 87
                },
                {
                "hcl_ppm": 50,
                "5": 36,
                "10": 48,
                "15": 55,
                "20": 60,
                "25": 66,
                "30": 69,
                "35": 74,
                "40": 76,
                "45": 79,
                "50": 81,
                "55": 84,
                "60": 87
                },
                {
                "hcl_ppm": 60,
                "5": 37,
                "10": 48,
                "15": 56,
                "20": 61,
                "25": 66,
                "30": 69,
                "35": 74,
                "40": 76,
                "45": 79,
                "50": 81,
                "55": 84,
                "60": 87
                },
                {
                "hcl_ppm": 70,
                "5": 37,
                "10": 49,
                "15": 56,
                "20": 61,
                "25": 66,
                "30": 69,
                "35": 74,
                "40": 76,
                "45": 79,
                "50": 81,
                "55": 84,
                "60": 87
                },
                {
                "hcl_ppm": 80,
                "5": 37,
                "10": 49,
                "15": 56,
                "20": 61,
                "25": 66,
                "30": 69,
                "35": 74,
                "40": 76,
                "45": 79,
                "50": 81,
                "55": 84,
                "60": 87
                },
                {
                "hcl_ppm": 100,
                "5": 38,
                "10": 49,
                "15": 57,
                "20": 62,
                "25": 66,
                "30": 70,
                "35": 74,
                "40": 76,
                "45": 79,
                "50": 81,
                "55": 84,
                "60": 87
                },
                {
                "hcl_ppm": 200,
                "5": 39,
                "10": 51,
                "15": 58,
                "20": 63,
                "25": 68,
                "30": 71,
                "35": 74,
                "40": 77,
                "45": 79,
                "50": 81,
                "55": 84,
                "60": 87
                },
                {
                "hcl_ppm": 300,
                "5": 40,
                "10": 52,
                "15": 59,
                "20": 64,
                "25": 68,
                "30": 72,
                "35": 75,
                "40": 78,
                "45": 80,
                "50": 82,
                "55": 84,
                "60": 87
                },
                {
                "hcl_ppm": 400,
                "5": 41,
                "10": 52,
                "15": 60,
                "20": 65,
                "25": 69,
                "30": 73,
                "35": 76,
                "40": 78,
                "45": 81,
                "50": 83,
                "55": 85,
                "60": 87
                },
                {
                "hcl_ppm": 500,
                "5": 42,
                "10": 53,
                "15": 60,
                "20": 65,
                "25": 70,
                "30": 73,
                "35": 76,
                "40": 79,
                "45": 81,
                "50": 83,
                "55": 85,
                "60": 87
                },
                {
                "hcl_ppm": 600,
                "5": 42,
                "10": 53,
                "15": 61,
                "20": 66,
                "25": 70,
                "30": 73,
                "35": 76,
                "40": 79,
                "45": 81,
                "50": 84,
                "55": 86,
                "60": 87
                },
                {
                "hcl_ppm": 700,
                "5": 42,
                "10": 54,
                "15": 61,
                "20": 66,
                "25": 70,
                "30": 74,
                "35": 77,
                "40": 79,
                "45": 82,
                "50": 84,
                "55": 86,
                "60": 88
                },
                {
                "hcl_ppm": 800,
                "5": 43,
                "10": 54,
                "15": 61,
                "20": 66,
                "25": 71,
                "30": 74,
                "35": 77,
                "40": 80,
                "45": 82,
                "50": 84,
                "55": 86,
                "60": 88
                },
                {
                "hcl_ppm": 900,
                "5": 43,
                "10": 54,
                "15": 61,
                "20": 67,
                "25": 71,
                "30": 74,
                "35": 77,
                "40": 80,
                "45": 82,
                "50": 84,
                "55": 86,
                "60": 88
                },
                {
                "hcl_ppm": 1000,
                "5": 43,
                "10": 55,
                "15": 62,
                "20": 67,
                "25": 71,
                "30": 75,
                "35": 78,
                "40": 80,
                "45": 83,
                "50": 85,
                "55": 87,
                "60": 88
                },
                {
                "hcl_ppm": 2000,
                "5": 45,
                "10": 56,
                "15": 63,
                "20": 68,
                "25": 73,
                "30": 76,
                "35": 79,
                "40": 82,
                "45": 84,
                "50": 86,
                "55": 88,
                "60": 90
                },
                {
                "hcl_ppm": 3000,
                "5": 46,
                "10": 57,
                "15": 64,
                "20": 69,
                "25": 73,
                "30": 77,
                "35": 80,
                "40": 83,
                "45": 85,
                "50": 87,
                "55": 89,
                "60": 91
                },
                {
                "hcl_ppm": 4000,
                "5": 46,
                "10": 58,
                "15": 65,
                "20": 70,
                "25": 74,
                "30": 78,
                "35": 81,
                "40": 83,
                "45": 86,
                "50": 88,
                "55": 90,
                "60": 91
                },
                {
                "hcl_ppm": 5000,
                "5": 47,
                "10": 58,
                "15": 65,
                "20": 70,
                "25": 75,
                "30": 78,
                "35": 81,
                "40": 84,
                "45": 86,
                "50": 88,
                "55": 90,
                "60": 92
                },
                {
                "hcl_ppm": 10000,
                "5": 48,
                "10": 60,
                "15": 67,
                "20": 72,
                "25": 76,
                "30": 80,
                "35": 83,
                "40": 85,
                "45": 88,
                "50": 90,
                "55": 92,
                "60": 93
                }
            ]
            }
        const DewPointSourGas = {
            "title": "Таблица точек росы серной кислоты для газа типа SO₃-H₂O",
            "xAxis": "Влажность в газе (об.%)",
            "yAxis": "SO₃ в газе (объемный ppm)",
            "units": "°C",
            "data": [
                {
                "so3_ppm": 0.0,
                "5": 33,
                "10": 46,
                "15": 53,
                "20": 60,
                "25": 66,
                "30": 69,
                "35": 74,
                "40": 76,
                "45": 79,
                "50": 81,
                "55": 84,
                "60": 87
                },
                {
                "so3_ppm": 0.1,
                "5": 87,
                "10": 95,
                "15": 100,
                "20": 103,
                "25": 106,
                "30": 108,
                "35": 111,
                "40": 112,
                "45": 114,
                "50": 115,
                "55": 117,
                "60": 118
                },
                {
                "so3_ppm": 1,
                "5": 106,
                "10": 114,
                "15": 119,
                "20": 122,
                "25": 125,
                "30": 127,
                "35": 129,
                "40": 130,
                "45": 132,
                "50": 133,
                "55": 134,
                "60": 135
                },
                {
                "so3_ppm": 2,
                "5": 113,
                "10": 120,
                "15": 125,
                "20": 128,
                "25": 131,
                "30": 133,
                "35": 134,
                "40": 136,
                "45": 137,
                "50": 139,
                "55": 140,
                "60": 141
                },
                {
                "so3_ppm": 3,
                "5": 117,
                "10": 124,
                "15": 128,
                "20": 132,
                "25": 134,
                "30": 136,
                "35": 138,
                "40": 139,
                "45": 141,
                "50": 142,
                "55": 143,
                "60": 144
                },
                {
                "so3_ppm": 4,
                "5": 119,
                "10": 127,
                "15": 131,
                "20": 134,
                "25": 137,
                "30": 139,
                "35": 140,
                "40": 142,
                "45": 143,
                "50": 145,
                "55": 146,
                "60": 147
                },
                {
                "so3_ppm": 5,
                "5": 122,
                "10": 129,
                "15": 133,
                "20": 136,
                "25": 139,
                "30": 141,
                "35": 142,
                "40": 144,
                "45": 145,
                "50": 146,
                "55": 148,
                "60": 149
                },
                {
                "so3_ppm": 6,
                "5": 123,
                "10": 131,
                "15": 135,
                "20": 138,
                "25": 140,
                "30": 142,
                "35": 144,
                "40": 146,
                "45": 147,
                "50": 148,
                "55": 149,
                "60": 150
                },
                {
                "so3_ppm": 7,
                "5": 125,
                "10": 132,
                "15": 136,
                "20": 139,
                "25": 142,
                "30": 144,
                "35": 145,
                "40": 147,
                "45": 148,
                "50": 149,
                "55": 150,
                "60": 151
                },
                {
                "so3_ppm": 8,
                "5": 126,
                "10": 133,
                "15": 138,
                "20": 141,
                "25": 143,
                "30": 145,
                "35": 147,
                "40": 148,
                "45": 149,
                "50": 151,
                "55": 152,
                "60": 153
                },
                {
                "so3_ppm": 9,
                "5": 127,
                "10": 134,
                "15": 139,
                "20": 142,
                "25": 144,
                "30": 146,
                "35": 148,
                "40": 149,
                "45": 150,
                "50": 152,
                "55": 153,
                "60": 154
                },
                {
                "so3_ppm": 10,
                "5": 129,
                "10": 135,
                "15": 140,
                "20": 143,
                "25": 145,
                "30": 147,
                "35": 149,
                "40": 150,
                "45": 151,
                "50": 153,
                "55": 154,
                "60": 155
                },
                {
                "so3_ppm": 20,
                "5": 136,
                "10": 142,
                "15": 146,
                "20": 149,
                "25": 152,
                "30": 153,
                "35": 155,
                "40": 156,
                "45": 158,
                "50": 159,
                "55": 160,
                "60": 161
                },
                {
                "so3_ppm": 30,
                "5": 140,
                "10": 147,
                "15": 150,
                "20": 153,
                "25": 155,
                "30": 157,
                "35": 159,
                "40": 160,
                "45": 161,
                "50": 162,
                "55": 163,
                "60": 164
                },
                {
                "so3_ppm": 40,
                "5": 143,
                "10": 150,
                "15": 153,
                "20": 156,
                "25": 158,
                "30": 160,
                "35": 162,
                "40": 163,
                "45": 164,
                "50": 165,
                "55": 166,
                "60": 167
                },
                {
                "so3_ppm": 50,
                "5": 146,
                "10": 152,
                "15": 156,
                "20": 158,
                "25": 161,
                "30": 162,
                "35": 164,
                "40": 165,
                "45": 166,
                "50": 167,
                "55": 168,
                "60": 169
                },
                {
                "so3_ppm": 60,
                "5": 148,
                "10": 154,
                "15": 158,
                "20": 160,
                "25": 162,
                "30": 164,
                "35": 166,
                "40": 167,
                "45": 168,
                "50": 169,
                "55": 170,
                "60": 171
                },
                {
                "so3_ppm": 70,
                "5": 149,
                "10": 156,
                "15": 159,
                "20": 162,
                "25": 164,
                "30": 166,
                "35": 167,
                "40": 168,
                "45": 169,
                "50": 171,
                "55": 171,
                "60": 172
                },
                {
                "so3_ppm": 80,
                "5": 151,
                "10": 157,
                "15": 161,
                "20": 163,
                "25": 165,
                "30": 167,
                "35": 168,
                "40": 170,
                "45": 171,
                "50": 172,
                "55": 173,
                "60": 174
                },
                {
                "so3_ppm": 90,
                "5": 152,
                "10": 158,
                "15": 162,
                "20": 164,
                "25": 167,
                "30": 168,
                "35": 170,
                "40": 171,
                "45": 172,
                "50": 173,
                "55": 174,
                "60": 175
                },
                {
                "so3_ppm": 100,
                "5": 154,
                "10": 159,
                "15": 163,
                "20": 166,
                "25": 168,
                "30": 169,
                "35": 171,
                "40": 172,
                "45": 173,
                "50": 174,
                "55": 175,
                "60": 176
                },
                {
                "so3_ppm": 200,
                "5": 162,
                "10": 167,
                "15": 171,
                "20": 173,
                "25": 175,
                "30": 176,
                "35": 178,
                "40": 179,
                "45": 180,
                "50": 181,
                "55": 182,
                "60": 182
                },
                {
                "so3_ppm": 300,
                "5": 167,
                "10": 172,
                "15": 175,
                "20": 177,
                "25": 179,
                "30": 181,
                "35": 182,
                "40": 183,
                "45": 184,
                "50": 185,
                "55": 186,
                "60": 187
                },
                {
                "so3_ppm": 400,
                "5": 170,
                "10": 175,
                "15": 178,
                "20": 181,
                "25": 182,
                "30": 184,
                "35": 185,
                "40": 186,
                "45": 187,
                "50": 188,
                "55": 189,
                "60": 189
                },
                {
                "so3_ppm": 500,
                "5": 173,
                "10": 178,
                "15": 181,
                "20": 183,
                "25": 185,
                "30": 186,
                "35": 188,
                "40": 189,
                "45": 189,
                "50": 190,
                "55": 191,
                "60": 192
                }
            ]
            }

        const CorrosionHCL = {
            "title": "Отношение между концентрацией соляной кислоты и скоростью коррозии",
            "steelTypes": ["Mild Steel", "SUS 304", "SUS 316L"],
            "temperatures": [40, 80],
            "testDuration": "6 hrs",
            "xAxis": "Концентрация HCl (%)",
            "yAxis": "Скорость коррозии (мг/см²/час)",
            "data": [
                {
                "steelType": "Mild Steel",
                "datasets": [
                    {
                    "temperature": 40,
                    "points": [
                        { "concentration": 3, "corrosionRate": 1.0 },
                        { "concentration": 10, "corrosionRate": 2.2 },
                        { "concentration": 20, "corrosionRate": 3.9 }
                    ]
                    },
                    {
                    "temperature": 80,
                    "points": [
                        { "concentration": 3, "corrosionRate": 20 },
                        { "concentration": 10, "corrosionRate": 34 },
                        { "concentration": 20, "corrosionRate": 51 }
                    ]
                    }
                ]
                },
                {
                "steelType": "SUS 304",
                "datasets": [
                    {
                    "temperature": 40,
                    "points": [
                        { "concentration": 3, "corrosionRate": 0.1 },
                        { "concentration": 10, "corrosionRate": 0.24 },
                        { "concentration": 20, "corrosionRate": 0.35 }
                    ]
                    },
                    {
                    "temperature": 80,
                    "points": [
                        { "concentration": 3, "corrosionRate": 1.0 },
                        { "concentration": 10, "corrosionRate": 4.0 },
                        { "concentration": 20, "corrosionRate": 17.0 }
                    ]
                    }
                ]
                },
                {
                "steelType": "SUS 316L",
                "datasets": [
                    {
                    "temperature": 40,
                    "points": [
                        { "concentration": 3, "corrosionRate": 0.01 },
                        { "concentration": 10, "corrosionRate": 0.2 },
                        { "concentration": 20, "corrosionRate": 0.55 }
                    ]
                    },
                    {
                    "temperature": 80,
                    "points": [
                        { "concentration": 3, "corrosionRate": 1.0 },
                        { "concentration": 10, "corrosionRate": 4.5 },
                        { "concentration": 20, "corrosionRate": 14.0 }
                    ]
                    }
                ]
                }
            ]}

            // Create H2SO4 heatmap
            function createH2SO4Heatmap() {
                        const ctx = document.getElementById('h2so4HeatmapChart').getContext('2d');
                        
                        // Extract data for heatmap
                        const waterValues = [5, 10, 15, 20, 25, 30];
                        const so3Values = [1, 5, 10, 20, 30, 50, 100];
                        const dewPoints = [];
                        
                        for (const so3Value of so3Values) {
                            const dewPointRow = [];
                            for (const waterValue of waterValues) {
                                // Find the closest value in the reference data
                                const refRow = DewPointSourGas.data.find(row => row.so3_ppm === so3Value);
                                if (refRow) {
                                    dewPointRow.push(refRow[waterValue.toString()]);
                                } else {
                                    // Interpolate or approximate if exact value not found
                                    let lowerRow = null;
                                    let upperRow = null;
                                    
                                    for (let i = 0; i < DewPointSourGas.data.length - 1; i++) {
                                        if (DewPointSourGas.data[i].so3_ppm < so3Value && DewPointSourGas.data[i+1].so3_ppm > so3Value) {
                                            lowerRow = DewPointSourGas.data[i];
                                            upperRow = DewPointSourGas.data[i+1];
                                            break;
                                        }
                                    }
                                    
                                    if (lowerRow && upperRow) {
                                        const lowerDewPoint = lowerRow[waterValue.toString()];
                                        const upperDewPoint = upperRow[waterValue.toString()];
                                        const ratio = (so3Value - lowerRow.so3_ppm) / (upperRow.so3_ppm - lowerRow.so3_ppm);
                                        dewPointRow.push(lowerDewPoint + ratio * (upperDewPoint - lowerDewPoint));
                                    } else {
                                        dewPointRow.push(null);
                                    }
                                }
                            }
                            dewPoints.push(dewPointRow);
                        }
                        
                        // Create datasets for line chart (one line per SO3 value)
                        const datasets = [];
                        const colors = [
                            'rgba(54, 162, 235, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 99, 132, 1)',
                            'rgba(255, 159, 64, 1)',
                            'rgba(255, 205, 86, 1)',
                            'rgba(201, 203, 207, 1)'
                        ];
                        
                        for (let i = 0; i < so3Values.length; i++) {
                            datasets.push({
                                label: `SO₃: ${so3Values[i]} ppm`,
                                data: dewPoints[i],
                                borderColor: colors[i % colors.length],
                                backgroundColor: colors[i % colors.length].replace('1)', '0.2)'),
                                tension: 0.1
                            });
                        }
                        
                        // Create chart
                        const h2so4Chart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: waterValues.map(val => `${val}%`),
                                datasets: datasets
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    title: {
                                        display: true,
                                        text: currentLanguage === 'ru' ? 
                                            'Точка росы H₂SO₄ в зависимости от SO₃ (при разном H₂O)' : 
                                            'H₂SO₄ Dew Point vs SO₃ Content (at different H₂O)',
                                        font: {
                                            size: 16
                                        }
                                    },
                                    tooltip: {
                                        mode: 'index',
                                        intersect: false
                                    },
                                    legend: {
                                        position: 'bottom'
                                    }
                                },
                                scales: {
                                    x: {
                                        title: {
                                            display: true,
                                            text: currentLanguage === 'ru' ? 'Содержание H₂O (% об.)' : 'H₂O Content (% vol.)'
                                        }
                                    },
                                    y: {
                                        title: {
                                            display: true,
                                            text: currentLanguage === 'ru' ? 'Точка росы (°C)' : 'Dew Point (°C)'
                                        }
                                    }
                                }
                            }
                        });
                    }
                    
                    // Create HCl heatmap
                    function createHClHeatmap() {
                        const ctx = document.getElementById('hclHeatmapChart').getContext('2d');
                        
                        // Extract data for heatmap
                        const waterValues = [5, 10, 15, 20, 25, 30];
                        const hclValues = [10, 50, 100, 300, 500, 1000];
                        const dewPoints = [];
                        
                        for (const hclValue of hclValues) {
                            const dewPointRow = [];
                            for (const waterValue of waterValues) {
                                // Find the closest value in the reference data
                                const refRow = DewPointHCL.data.find(row => row.hcl_ppm === hclValue);
                                if (refRow) {
                                    dewPointRow.push(refRow[waterValue.toString()]);
                                } else {
                                    // Interpolate or approximate if exact value not found
                                    let lowerRow = null;
                                    let upperRow = null;
                                    
                                    for (let i = 0; i < DewPointHCL.data.length - 1; i++) {
                                        if (DewPointHCL.data[i].hcl_ppm < hclValue && DewPointHCL.data[i+1].hcl_ppm > hclValue) {
                                            lowerRow = DewPointHCL.data[i];
                                            upperRow = DewPointHCL.data[i+1];
                                            break;
                                        }
                                    }
                                    
                                    if (lowerRow && upperRow) {
                                        const lowerDewPoint = lowerRow[waterValue.toString()];
                                        const upperDewPoint = upperRow[waterValue.toString()];
                                        const ratio = (hclValue - lowerRow.hcl_ppm) / (upperRow.hcl_ppm - lowerRow.hcl_ppm);
                                        dewPointRow.push(lowerDewPoint + ratio * (upperDewPoint - lowerDewPoint));
                                    } else {
                                        dewPointRow.push(null);
                                    }
                                }
                            }
                            dewPoints.push(dewPointRow);
                        }
                        
                        // Create datasets for line chart (one line per HCl value)
                        const datasets = [];
                        const colors = [
                            'rgba(255, 99, 132, 1)',
                            'rgba(255, 159, 64, 1)',
                            'rgba(255, 205, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(201, 203, 207, 1)'
                        ];
                        
                        for (let i = 0; i < hclValues.length; i++) {
                            datasets.push({
                                label: `HCl: ${hclValues[i]} ppm`,
                                data: dewPoints[i],
                                borderColor: colors[i % colors.length],
                                backgroundColor: colors[i % colors.length].replace('1)', '0.2)'),
                                tension: 0.1
                            });
                        }
                        
                        // Create chart
                        const hclChart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: waterValues.map(val => `${val}%`),
                                datasets: datasets
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    title: {
                                        display: true,
                                        text: currentLanguage === 'ru' ? 
                                            'Точка росы HCl в зависимости от HCl (при разном H₂O)' : 
                                            'HCl Dew Point vs HCl Content (at different H₂O)',
                                        font: {
                                            size: 16
                                        }
                                    },
                                    tooltip: {
                                        mode: 'index',
                                        intersect: false
                                    },
                                    legend: {
                                        position: 'bottom'
                                    }
                                },
                                scales: {
                                    x: {
                                        title: {
                                            display: true,
                                            text: currentLanguage === 'ru' ? 'Содержание H₂O (% об.)' : 'H₂O Content (% vol.)'
                                        }
                                    },
                                    y: {
                                        title: {
                                            display: true,
                                            text: currentLanguage === 'ru' ? 'Точка росы (°C)' : 'Dew Point (°C)'
                                        }
                                    }
                                }
                            }
                        });
                    }
                    
                    // Create corrosion rate chart
                    function createCorrosionRateChart() {
                        const ctx = document.getElementById('corrosionRateChart').getContext('2d');
                        
                        // Process data for chart
                        const concentrations = [3, 10, 20];
                        const temperatures = [40, 80];
                        const datasets = [];
                        
                        // Colors for different materials and temperatures
                        const materialColors = {
                            'Mild Steel': ['rgba(255, 99, 132, 1)', 'rgba(255, 99, 132, 0.7)'],
                            'SUS 304': ['rgba(54, 162, 235, 1)', 'rgba(54, 162, 235, 0.7)'],
                            'SUS 316L': ['rgba(75, 192, 192, 1)', 'rgba(75, 192, 192, 0.7)']
                        };
                        
                        // Create datasets for each material and temperature
                        CorrosionHCL.data.forEach(steelData => {
                            steelData.datasets.forEach((tempData, index) => {
                                const dataPoints = tempData.points.map(point => point.corrosionRate);
                                
                                datasets.push({
                                    label: `${steelData.steelType} @ ${tempData.temperature}°C`,
                                    data: dataPoints,
                                    backgroundColor: materialColors[steelData.steelType][index],
                                    borderColor: materialColors[steelData.steelType][index].replace('0.7)', '1)'),
                                    borderWidth: 1,
                                    borderRadius: 4
                                });
                            });
                        });
                        
                        // Create chart
                        const corrosionChart = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: concentrations.map(val => `${val}% HCl`),
                                datasets: datasets
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    title: {
                                        display: true,
                                        text: currentLanguage === 'ru' ? 
                                            'Скорость коррозии различных материалов в HCl' : 
                                            'Corrosion Rate of Different Materials in HCl',
                                        font: {
                                            size: 16
                                        }
                                    },
                                    tooltip: {
                                        mode: 'index',
                                        intersect: false
                                    },
                                    legend: {
                                        position: 'bottom'
                                    }
                                },
                                scales: {
                                    x: {
                                        title: {
                                            display: true,
                                            text: currentLanguage === 'ru' ? 'Концентрация HCl (%)' : 'HCl Concentration (%)'
                                        }
                                    },
                                    y: {
                                        type: 'logarithmic',
                                        title: {
                                            display: true,
                                            text: currentLanguage === 'ru' ? 'Скорость коррозии (мг/см²/час)' : 'Corrosion Rate (mg/cm²/hour)'
                                        }
                                    }
                                }
                            }
                        });
                    }
                    
                    // Initial language setup
                    document.addEventListener('DOMContentLoaded', function() {
                        // Set Russian as default language
                        setLanguage('ru');
                        
                        // Populate tables and perform initial calculations
                        populateReferenceTables();
                        performCalculations();
                        
                        // Initialize tabs
                        document.getElementById('calculator').style.display = 'block';
                        document.getElementById('reference-data').style.display = 'none';
                        document.getElementById('theory').style.display = 'none';
                        document.getElementById('recommendations').style.display = 'none';
                        document.getElementById('references').style.display = 'none';
                    });

        // Function to update the risk assessment visualization based on temperature values
        function updateRiskVisualization() {
            // Get the calculated dew point and recommended temperature
            const dewPointC = parseFloat(document.getElementById('h2so4-dew-point').textContent);
            const recommendedTemp = parseFloat(document.getElementById('recommended-temp').textContent);
            
            // Define temperature ranges for risk assessment
            const highRiskTemp = dewPointC;
            const mediumRiskTemp = highRiskTemp + 10;
            const lowRiskTemp = mediumRiskTemp + 10;
            
            // Get the risk visualizations
            const highRiskElement = document.querySelector('.corrosion-risk-high');
            const mediumRiskElement = document.querySelector('.corrosion-risk-medium');
            const lowRiskElement = document.querySelector('.corrosion-risk-low');
            
            // Update risk visualization text
            if (currentLanguage === 'ru') {
                highRiskElement.innerHTML = `<div class="font-medium">T < ${highRiskTemp.toFixed(1)}°C</div><div class="text-sm">Высокий риск</div>`;
                mediumRiskElement.innerHTML = `<div class="font-medium">${highRiskTemp.toFixed(1)}°C < T < ${mediumRiskTemp.toFixed(1)}°C</div><div class="text-sm">Средний риск</div>`;
                lowRiskElement.innerHTML = `<div class="font-medium">T > ${mediumRiskTemp.toFixed(1)}°C</div><div class="text-sm">Низкий риск</div>`;
            } else {
                highRiskElement.innerHTML = `<div class="font-medium">T < ${highRiskTemp.toFixed(1)}°C</div><div class="text-sm">High Risk</div>`;
                mediumRiskElement.innerHTML = `<div class="font-medium">${highRiskTemp.toFixed(1)}°C < T < ${mediumRiskTemp.toFixed(1)}°C</div><div class="text-sm">Medium Risk</div>`;
                lowRiskElement.innerHTML = `<div class="font-medium">T > ${mediumRiskTemp.toFixed(1)}°C</div><div class="text-sm">Low Risk</div>`;
            }
        }
        
        // Math helper functions for more complex calculations
        function interpolate(x, x1, x2, y1, y2) {
            // Linear interpolation between two points
            if (x2 === x1) return y1; // Prevent division by zero
            return y1 + (x - x1) * (y2 - y1) / (x2 - x1);
        }
        
        function findClosestIndices(array, value) {
            // Find the indices of the two closest values in the array
            if (value <= array[0]) return [0, 0];
            if (value >= array[array.length - 1]) return [array.length - 1, array.length - 1];
            
            let lowerIndex = 0;
            while (lowerIndex < array.length - 1 && array[lowerIndex + 1] <= value) {
                lowerIndex++;
            }
            
            return [lowerIndex, lowerIndex + 1];
        }
        
        // Function to get tooltip text in the current language
        function getTooltipText(key) {
            const tooltips = {
                'water-content': {
                    'ru': 'Содержание водяного пара в газовой смеси. Влияет на точку росы всех видов кислот.',
                    'en': 'Water vapor content in the gas mixture. Affects the dew point of all types of acids.'
                },
                'so3-content': {
                    'ru': 'Содержание SO₃ в газовой смеси. Образуется при окислении SO₂ и является предшественником серной кислоты.',
                    'en': 'SO₃ content in the gas mixture. Formed by oxidation of SO₂ and is a precursor to sulfuric acid.'
                },
                'hcl-content': {
                    'ru': 'Содержание хлороводорода в газовой смеси. Образуется при сжигании хлорсодержащих веществ.',
                    'en': 'Hydrogen chloride content in the gas mixture. Formed when burning chlorine-containing substances.'
                },
                'h2s-content': {
                    'ru': 'Содержание сероводорода в газовой смеси. Распространен в нефтегазовых процессах.',
                    'en': 'Hydrogen sulfide content in the gas mixture. Common in oil and gas processes.'
                },
                'system-pressure': {
                    'ru': 'Общее давление в системе. Влияет на парциальные давления компонентов и точку росы.',
                    'en': 'Overall system pressure. Affects partial pressures of components and dew point.'
                }
            };
            
            return tooltips[key] ? tooltips[key][currentLanguage] : '';
        }
        
        // Enhanced error detection and handling
        function validateInputs() {
            let isValid = true;
            let errorMessage = '';
            
            // Check each input field for valid values
            const fieldsToCheck = [
                { id: 'water-content', min: 0, max: 100, name: { 'ru': 'Содержание воды', 'en': 'Water content' } },
                { id: 'system-pressure', min: 0.1, max: 50, name: { 'ru': 'Давление системы', 'en': 'System pressure' } }
            ];
            
            // Add acid-specific fields based on selected acid
            if (currentAcid === 'h2so4') {
                fieldsToCheck.push({ id: 'so3-content', min: 0, max: 1000, name: { 'ru': 'Содержание SO₃', 'en': 'SO₃ content' } });
            } else if (currentAcid === 'hcl') {
                fieldsToCheck.push({ id: 'hcl-content', min: 0, max: 10000, name: { 'ru': 'Содержание HCl', 'en': 'HCl content' } });
            } else if (currentAcid === 'h2s') {
                fieldsToCheck.push({ id: 'h2s-content', min: 0, max: 100, name: { 'ru': 'Содержание H₂S', 'en': 'H₂S content' } });
            }
            
            fieldsToCheck.forEach(field => {
                const element = document.getElementById(field.id);
                if (element) {
                    const value = parseFloat(element.value);
                    
                    if (isNaN(value) || value < field.min || value > field.max) {
                        isValid = false;
                        errorMessage += `${field.name[currentLanguage]}: ${currentLanguage === 'ru' ? 
                            `должно быть между ${field.min} и ${field.max}` : 
                            `must be between ${field.min} and ${field.max}`}.\n`;
                    }
                }
            });
            
            return { isValid, errorMessage };
        }
        
        // Function to show error messages
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4';
            errorDiv.setAttribute('role', 'alert');
            errorDiv.innerHTML = `
                <strong class="font-bold">${currentLanguage === 'ru' ? 'Ошибка!' : 'Error!'}</strong>
                <span class="block sm:inline">${message}</span>
                <span class="absolute top-0 bottom-0 right-0 px-4 py-3">
                    <svg class="fill-current h-6 w-6 text-red-500" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                        <title>${currentLanguage === 'ru' ? 'Закрыть' : 'Close'}</title>
                        <path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/>
                    </svg>
                </span>
            `;
            
            // Insert at the top of the result area
            const resultsDiv = document.getElementById('results');
            resultsDiv.insertBefore(errorDiv, resultsDiv.firstChild);
            
            // Add click event to close button
            errorDiv.querySelector('svg').addEventListener('click', function() {
                errorDiv.remove();
            });
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.remove();
                }
            }, 5000);
        }
        
        // Enhanced calculation function with error handling
        function performCalculationsWithValidation() {
            // Clear any existing error messages
            document.querySelectorAll('[role="alert"]').forEach(el => el.remove());
            
            // Validate inputs
            const validation = validateInputs();
            if (!validation.isValid) {
                showError(validation.errorMessage);
                return;
            }
            
            // Proceed with calculations
            try {
                performCalculations();
                updateRiskVisualization();
            } catch (error) {
                console.error('Calculation error:', error);
                showError(currentLanguage === 'ru' ? 
                    'Произошла ошибка при расчете. Проверьте входные данные.' : 
                    'An error occurred during calculation. Please check your input data.');
            }
        }
        
        // Override the click handler for the calculate button
        document.addEventListener('DOMContentLoaded', function() {
            const calculateButton = document.getElementById('calculate-btn');
            if (calculateButton) {
                // Remove existing listeners
                const newButton = calculateButton.cloneNode(true);
                calculateButton.parentNode.replaceChild(newButton, calculateButton);
                
                // Add new enhanced handler
                newButton.addEventListener('click', performCalculationsWithValidation);
            }
        });
        
        // Export functionality
        function exportToCSV() {
            // Get current values
            const waterContent = parseFloat(document.getElementById('water-content').value);
            const waterUnit = document.getElementById('water-units').value;
            const systemPressure = parseFloat(document.getElementById('system-pressure').value);
            const pressureUnit = document.getElementById('pressure-units').value;
            
            let acidContent = 0;
            let acidUnit = '';
            let acidType = '';
            
            if (currentAcid === 'h2so4') {
                acidContent = parseFloat(document.getElementById('so3-content').value);
                acidUnit = document.getElementById('so3-units').value;
                acidType = 'SO₃';
            } else if (currentAcid === 'hcl') {
                acidContent = parseFloat(document.getElementById('hcl-content').value);
                acidUnit = document.getElementById('hcl-units').value;
                acidType = 'HCl';
            } else if (currentAcid === 'h2s') {
                acidContent = parseFloat(document.getElementById('h2s-content').value);
                acidUnit = document.getElementById('h2s-units').value;
                acidType = 'H₂S';
            }
            
            const dewPoint = parseFloat(document.getElementById('h2so4-dew-point').textContent);
            const recommendedTemp = parseFloat(document.getElementById('recommended-temp').textContent);
            const waterDewPoint = parseFloat(document.getElementById('water-dew-point').textContent);
            
            // Create CSV content
            let csvContent = currentLanguage === 'ru' ? 
                "Параметры расчета точки росы кислоты\n" : 
                "Acid Dew Point Calculation Parameters\n";
                
            csvContent += "\n";
            
            // Add calculation parameters
            csvContent += currentLanguage === 'ru' ? "Параметры:\n" : "Parameters:\n";
            csvContent += `${currentLanguage === 'ru' ? "Тип кислоты" : "Acid type"},${currentAcid === 'h2so4' ? 'H₂SO₄' : (currentAcid === 'hcl' ? 'HCl' : 'H₂S')}\n`;
            csvContent += `${currentLanguage === 'ru' ? "Содержание воды" : "Water content"},${waterContent} ${waterUnit}\n`;
            csvContent += `${currentLanguage === 'ru' ? `Содержание ${acidType}` : `${acidType} content`},${acidContent} ${acidUnit}\n`;
            csvContent += `${currentLanguage === 'ru' ? "Давление системы" : "System pressure"},${systemPressure} ${pressureUnit}\n`;
            
            // Add calculation method
            let methodName = '';
            if (currentAcid === 'h2so4') {
                const methodSelect = document.getElementById('calculation-method-h2so4');
                methodName = methodSelect.options[methodSelect.selectedIndex].text;
            } else if (currentAcid === 'hcl') {
                const methodSelect = document.getElementById('calculation-method-hcl');
                methodName = methodSelect.options[methodSelect.selectedIndex].text;
            } else if (currentAcid === 'h2s') {
                const methodSelect = document.getElementById('calculation-method-h2s');
                methodName = methodSelect.options[methodSelect.selectedIndex].text;
            }
            
            csvContent += `${currentLanguage === 'ru' ? "Метод расчета" : "Calculation method"},${methodName}\n`;
            
            // Add results
            csvContent += "\n";
            csvContent += currentLanguage === 'ru' ? "Результаты:\n" : "Results:\n";
            csvContent += `${currentLanguage === 'ru' ? "Точка росы кислоты" : "Acid dew point"},${dewPoint} °C\n`;
            csvContent += `${currentLanguage === 'ru' ? "Рекомендуемая температура" : "Recommended temperature"},${recommendedTemp} °C\n`;
            csvContent += `${currentLanguage === 'ru' ? "Точка росы воды" : "Water dew point"},${waterDewPoint} °C\n`;
            
            // Create downloadable link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `acid_dew_point_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Add export button functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Create export button
            const exportButton = document.createElement('button');
            exportButton.className = 'btn-primary py-2 px-3 text-sm ml-2';
            exportButton.innerHTML = `<i class="fas fa-download mr-1"></i> <span class="lang-ru">Экспорт</span><span class="lang-en">Export</span>`;
            
            // Add to page
            const calculateButton = document.getElementById('calculate-btn');
            if (calculateButton && calculateButton.parentNode) {
                calculateButton.parentNode.appendChild(exportButton);
            }
            
            // Add click handler
            exportButton.addEventListener('click', exportToCSV);
            
            // Update language display for the new button
            setLanguage(currentLanguage);
        });
        
        // Performance optimization for charts
        let chartUpdateTimeout = null;
        
        function debounceGraphUpdate() {
            if (chartUpdateTimeout) {
                clearTimeout(chartUpdateTimeout);
            }
            
            chartUpdateTimeout = setTimeout(() => {
                updateGraph();
            }, 100);
        }
        
        // Update input handlers to use debounced updates
        document.addEventListener('DOMContentLoaded', function() {
            const inputFields = ['water-content', 'so3-content', 'hcl-content', 'h2s-content', 'system-pressure'];
            const sliders = ['water-content-slider', 'so3-content-slider', 'hcl-content-slider', 'h2s-content-slider', 'system-pressure-slider'];
            
            inputFields.forEach((field, index) => {
                const slider = sliders[index];
                
                document.getElementById(field).addEventListener('input', function() {
                    document.getElementById(slider).value = this.value;
                    performCalculations();
                    debounceGraphUpdate();  // Debounce graph update
                });
                
                document.getElementById(slider).addEventListener('input', function() {
                    document.getElementById(field).value = this.value;
                    performCalculations();
                    debounceGraphUpdate();  // Debounce graph update
                });
            });
        });
        // Print functionality
        function printCalculator() {
            // Prepare for printing
            const originalTitle = document.title;
            document.title = currentLanguage === 'ru' ? 
                'Отчет о расчете точки росы кислоты' : 
                'Acid Dew Point Calculation Report';
            
            // Add print-specific styles
            const printStyle = document.createElement('style');
            printStyle.type = 'text/css';
            printStyle.innerHTML = `
                @media print {
                    body {
                        font-size: 12pt;
                        color: #000;
                    }
                    
                    .no-print, .tab-btn, #langToggle {
                        display: none !important;
                    }
                    
                    .card {
                        break-inside: avoid;
                        border: 1px solid #ddd;
                        margin-bottom: 15px !important;
                        box-shadow: none !important;
                    }
                    
                    .container {
                        width: 100% !important;
                        max-width: none;
                        padding: 0 !important;
                        margin: 0 !important;
                    }
                    
                    h1, h2, h3 {
                        break-after: avoid;
                    }
                    
                    canvas {
                        max-width: 100% !important;
                        height: auto !important;
                    }
                    
                    .parameter-card {
                        page-break-inside: avoid;
                    }
                    
                    header {
                        background: none !important;
                        color: #000 !important;
                        padding: 0 !important;
                        margin-bottom: 1cm !important;
                    }
                    
                    header h1 {
                        font-size: 18pt !important;
                    }
                    
                    .print-date {
                        display: block !important;
                        text-align: right;
                        font-size: 10pt;
                        margin-bottom: 0.5cm;
                    }
                    
                    .page-break {
                        page-break-before: always;
                    }
                }
            `;
            document.head.appendChild(printStyle);
            
            // Add print date
            const printDate = document.createElement('div');
            printDate.className = 'print-date';
            printDate.style.display = 'none';
            
            const now = new Date();
            printDate.textContent = `${currentLanguage === 'ru' ? 'Дата печати' : 'Print date'}: ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;
            document.body.insertBefore(printDate, document.body.firstChild);
            
            // Execute print
            window.print();
            
            // Clean up
            document.head.removeChild(printStyle);
            document.body.removeChild(printDate);
            document.title = originalTitle;
        }
        
        // Add print button
        document.addEventListener('DOMContentLoaded', function() {
            // Create print button
            const printButton = document.createElement('button');
            printButton.className = 'btn-primary py-2 px-3 text-sm ml-2';
            printButton.innerHTML = `<i class="fas fa-print mr-1"></i> <span class="lang-ru">Печать</span><span class="lang-en">Print</span>`;
            
            // Add to page
            const calculateButton = document.getElementById('calculate-btn');
            if (calculateButton && calculateButton.parentNode) {
                calculateButton.parentNode.appendChild(printButton);
            }
            
            // Add click handler
            printButton.addEventListener('click', printCalculator);
            
            // Update language display for the new button
            setLanguage(currentLanguage);
        });
        
        // URL parameter functionality to save and share calculations
        function generateShareableUrl() {
            // Get current parameters
            const parameters = new URLSearchParams();
            
            // Add acid type
            parameters.set('acid', currentAcid);
            
            // Add method
            if (currentAcid === 'h2so4') {
                parameters.set('method', document.getElementById('calculation-method-h2so4').value);
            } else if (currentAcid === 'hcl') {
                parameters.set('method', document.getElementById('calculation-method-hcl').value);
            } else if (currentAcid === 'h2s') {
                parameters.set('method', document.getElementById('calculation-method-h2s').value);
            }
            
            // Add content values
            parameters.set('water', document.getElementById('water-content').value);
            parameters.set('waterUnit', document.getElementById('water-units').value);
            
            if (currentAcid === 'h2so4') {
                parameters.set('so3', document.getElementById('so3-content').value);
                parameters.set('so3Unit', document.getElementById('so3-units').value);
            } else if (currentAcid === 'hcl') {
                parameters.set('hcl', document.getElementById('hcl-content').value);
                parameters.set('hclUnit', document.getElementById('hcl-units').value);
            } else if (currentAcid === 'h2s') {
                parameters.set('h2s', document.getElementById('h2s-content').value);
                parameters.set('h2sUnit', document.getElementById('h2s-units').value);
            }
            
            // Add pressure
            parameters.set('pressure', document.getElementById('system-pressure').value);
            parameters.set('pressureUnit', document.getElementById('pressure-units').value);
            
            // Add language
            parameters.set('lang', currentLanguage);
            
            // Generate URL
            const url = `${window.location.href.split('?')[0]}?${parameters.toString()}`;
            return url;
        }
        
        function shareCalculation() {
            const url = generateShareableUrl();
            
            // Check if Web Share API is available
            if (navigator.share) {
                navigator.share({
                    title: currentLanguage === 'ru' ? 
                        'Расчет точки росы кислоты' : 
                        'Acid Dew Point Calculation',
                    text: currentLanguage === 'ru' ? 
                        'Посмотрите результаты моего расчета точки росы кислоты' : 
                        'Check out my acid dew point calculation results',
                    url: url
                }).catch(error => {
                    console.error('Error sharing', error);
                    copyToClipboard(url);
                });
            } else {
                // Fallback to copy to clipboard
                copyToClipboard(url);
            }
        }
        
        function copyToClipboard(text) {
            // Create temporary input element
            const input = document.createElement('input');
            input.value = text;
            document.body.appendChild(input);
            input.select();
            
            // Copy and clean up
            document.execCommand('copy');
            document.body.removeChild(input);
            
            // Show confirmation
            const message = currentLanguage === 'ru' ? 
                'Ссылка скопирована в буфер обмена!' : 
                'Link copied to clipboard!';
            
            // Display notification
            const notification = document.createElement('div');
            notification.className = 'bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded fixed bottom-4 right-4';
            notification.setAttribute('role', 'alert');
            notification.innerHTML = `
                <strong class="font-bold">${currentLanguage === 'ru' ? 'Готово!' : 'Done!'}</strong>
                <span class="block sm:inline">${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 3000);
        }
        
        // Add share button
        document.addEventListener('DOMContentLoaded', function() {
            // Create share button
            const shareButton = document.createElement('button');
            shareButton.className = 'btn-primary py-2 px-3 text-sm ml-2';
            shareButton.innerHTML = `<i class="fas fa-share-alt mr-1"></i> <span class="lang-ru">Поделиться</span><span class="lang-en">Share</span>`;
            
            // Add to page
            const calculateButton = document.getElementById('calculate-btn');
            if (calculateButton && calculateButton.parentNode) {
                calculateButton.parentNode.appendChild(shareButton);
            }
            
            // Add click handler
            shareButton.addEventListener('click', shareCalculation);
            
            // Update language display for the new button
            setLanguage(currentLanguage);
            
            // Check for URL parameters
            loadFromUrlParameters();
        });
        
        // Load calculation parameters from URL
        function loadFromUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            
            // Check if we have parameters
            if (urlParams.has('acid')) {
                // Set acid type
                const acid = urlParams.get('acid');
                if (['h2so4', 'hcl', 'h2s'].includes(acid)) {
                    // Find and click the corresponding button
                    const acidButton = document.querySelector(`.acid-type-btn[data-acid="${acid}"]`);
                    if (acidButton) {
                        acidButton.click();
                    }
                }
                
                // Set method if available
                if (urlParams.has('method')) {
                    const method = urlParams.get('method');
                    if (acid === 'h2so4') {
                        document.getElementById('calculation-method-h2so4').value = method;
                    } else if (acid === 'hcl') {
                        document.getElementById('calculation-method-hcl').value = method;
                    } else if (acid === 'h2s') {
                        document.getElementById('calculation-method-h2s').value = method;
                    }
                }
                
                // Set water content
                if (urlParams.has('water') && urlParams.has('waterUnit')) {
                    document.getElementById('water-content').value = urlParams.get('water');
                    document.getElementById('water-content-slider').value = urlParams.get('water');
                    document.getElementById('water-units').value = urlParams.get('waterUnit');
                }
                
                // Set acid content
                if (acid === 'h2so4' && urlParams.has('so3') && urlParams.has('so3Unit')) {
                    document.getElementById('so3-content').value = urlParams.get('so3');
                    document.getElementById('so3-content-slider').value = urlParams.get('so3');
                    document.getElementById('so3-units').value = urlParams.get('so3Unit');
                } else if (acid === 'hcl' && urlParams.has('hcl') && urlParams.has('hclUnit')) {
                    document.getElementById('hcl-content').value = urlParams.get('hcl');
                    document.getElementById('hcl-content-slider').value = urlParams.get('hcl');
                    document.getElementById('hcl-units').value = urlParams.get('hclUnit');
                } else if (acid === 'h2s' && urlParams.has('h2s') && urlParams.has('h2sUnit')) {
                    document.getElementById('h2s-content').value = urlParams.get('h2s');
                    document.getElementById('h2s-content-slider').value = urlParams.get('h2s');
                    document.getElementById('h2s-units').value = urlParams.get('h2sUnit');
                }
                
                // Set pressure
                if (urlParams.has('pressure') && urlParams.has('pressureUnit')) {
                    document.getElementById('system-pressure').value = urlParams.get('pressure');
                    document.getElementById('system-pressure-slider').value = urlParams.get('pressure');
                    document.getElementById('pressure-units').value = urlParams.get('pressureUnit');
                }
                
                // Set language
                if (urlParams.has('lang')) {
                    const lang = urlParams.get('lang');
                    if (['ru', 'en'].includes(lang) && lang !== currentLanguage) {
                        toggleLanguage();
                    }
                }
                
                // Calculate
                performCalculations();
            }
        }
        
        // Add keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            // Allow shortcuts only when not typing in input fields
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA' || event.target.tagName === 'SELECT') {
                return;
            }
            
            // Shortcuts with Ctrl/Command key
            if (event.ctrlKey || event.metaKey) {
                // Ctrl+P for print
                if (event.key === 'p') {
                    event.preventDefault();
                    printCalculator();
                }
                
                // Ctrl+S for share/save
                else if (event.key === 's') {
                    event.preventDefault();
                    shareCalculation();
                }
                
                // Ctrl+E for export
                else if (event.key === 'e') {
                    event.preventDefault();
                    exportToCSV();
                }
            }
            // Tab navigation (1-5)
            else if (event.key >= '1' && event.key <= '5' && !event.ctrlKey && !event.altKey && !event.shiftKey) {
                const tabIndex = parseInt(event.key) - 1;
                const tabButtons = document.querySelectorAll('.tab-btn');
                
                if (tabButtons.length > tabIndex) {
                    event.preventDefault();
                    tabButtons[tabIndex].click();
                }
            }
            // Language toggle with 'L'
            else if (event.key.toLowerCase() === 'l' && !event.ctrlKey && !event.altKey && !event.shiftKey) {
                event.preventDefault();
                toggleLanguage();
            }
            // Calculate with Enter
            else if (event.key === 'Enter' && !event.ctrlKey && !event.altKey && !event.shiftKey) {
                event.preventDefault();
                performCalculationsWithValidation();
            }
        });
        
        // Help modal for keyboard shortcuts
        function showKeyboardShortcutsHelp() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50';
            
            const modalContent = document.createElement('div');
            modalContent.className = 'bg-white rounded-lg p-6 max-w-md mx-auto';
            
            const title = document.createElement('h3');
            title.className = 'text-lg font-bold mb-4 border-b pb-2';
            title.textContent = currentLanguage === 'ru' ? 'Клавиатурные сокращения' : 'Keyboard Shortcuts';
            
            const shortcuts = [
                { key: 'Ctrl+P', action: { ru: 'Печать', en: 'Print' } },
                { key: 'Ctrl+S', action: { ru: 'Поделиться ссылкой', en: 'Share link' } },
                { key: 'Ctrl+E', action: { ru: 'Экспорт в CSV', en: 'Export to CSV' } },
                { key: '1-5', action: { ru: 'Навигация по вкладкам', en: 'Tab navigation' } },
                { key: 'L', action: { ru: 'Переключение языка', en: 'Language toggle' } },
                { key: 'Enter', action: { ru: 'Выполнить расчет', en: 'Calculate' } }
            ];
            
            const shortcutsList = document.createElement('ul');
            shortcutsList.className = 'space-y-2';
            
            shortcuts.forEach(shortcut => {
                const listItem = document.createElement('li');
                listItem.className = 'flex justify-between';
                
                const keySpan = document.createElement('span');
                keySpan.className = 'font-mono bg-gray-100 px-2 py-1 rounded';
                keySpan.textContent = shortcut.key;
                
                const actionSpan = document.createElement('span');
                actionSpan.textContent = shortcut.action[currentLanguage];
                
                listItem.appendChild(keySpan);
                listItem.appendChild(actionSpan);
                
                shortcutsList.appendChild(listItem);
            });
            
            const closeButton = document.createElement('button');
            closeButton.className = 'mt-4 btn-primary w-full py-2';
            closeButton.textContent = currentLanguage === 'ru' ? 'Закрыть' : 'Close';
            
            closeButton.addEventListener('click', function() {
                document.body.removeChild(modal);
            });
            
            modalContent.appendChild(title);
            modalContent.appendChild(shortcutsList);
            modalContent.appendChild(closeButton);
            modal.appendChild(modalContent);
            
            document.body.appendChild(modal);
            
            // Close on background click or Escape key
            modal.addEventListener('click', function(event) {
                if (event.target === modal) {
                    document.body.removeChild(modal);
                }
            });
            
            document.addEventListener('keydown', function escHandler(event) {
                if (event.key === 'Escape') {
                    document.body.removeChild(modal);
                    document.removeEventListener('keydown', escHandler);
                }
            });
        }
        
        // Add keyboard help button
        document.addEventListener('DOMContentLoaded', function() {
            // Create keyboard help button
            const keyboardHelpButton = document.createElement('button');
            keyboardHelpButton.className = 'text-gray-600 hover:text-gray-800 mt-2 text-sm flex items-center';
            keyboardHelpButton.innerHTML = `<i class="fas fa-keyboard mr-1"></i> <span class="lang-ru">Клавиатурные сокращения</span><span class="lang-en">Keyboard shortcuts</span>`;
            
            // Add to page
            const footer = document.querySelector('footer');
            if (footer) {
                footer.appendChild(keyboardHelpButton);
            }
            
            // Add click handler
            keyboardHelpButton.addEventListener('click', showKeyboardShortcutsHelp);
            
            // Update language display
            setLanguage(currentLanguage);
        });
        
        // Final initialization
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Acid Dew Point Calculator initialized');
            
            // Perform initial calculations
            setTimeout(performCalculations, 100);
            
            // Show the active tab
            const activeTab = document.querySelector('.tab-btn.tab-active');
            if (activeTab) {
                activeTab.click();
            }
        });
    </script>
</body>
</html>